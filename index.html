<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalkulations-Trainer | Anmelden</title>
    <meta name="description" content="Ãœbungsapp fÃ¼r Preiskalkulation HÃ¶rakustik - Lernfeld 17.2">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="./icons/icon.svg">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Header -->
    <div class="header">
        <div class="header-icon">ğŸ“Š</div>
        <h1>Kalkulations-Trainer</h1>
        <p>Lernfeld 17.2 Â· HÃ¶rakustik</p>
    </div>

    <!-- Login Card -->
    <div class="card" id="loginCard">
        <div class="card-header">
            <span class="card-title">Willkommen</span>
        </div>
        
        <p class="text-muted mb-2">
            Gib deinen Namen ein, um zu starten oder dein Profil zu laden.
        </p>

        <div class="input-group">
            <label class="input-label" for="nameInput">Dein Name</label>
            <input 
                type="text" 
                id="nameInput" 
                class="input-field" 
                placeholder="z.B. Max"
                maxlength="20"
                autocomplete="off"
                autocapitalize="words"
            >
            <div class="input-error" id="nameError" style="display: none;">
                <span>âš ï¸</span>
                <span id="errorText"></span>
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-block btn-lg" id="startBtn" onclick="handleStart()">
            ğŸš€ Los geht's
        </button>
    </div>

    <!-- Existing Profiles -->
    <div class="card" id="profilesCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">Vorhandene Profile</span>
        </div>
        
        <ul class="profile-list" id="profileList">
            <!-- Wird per JS gefÃ¼llt -->
        </ul>
    </div>

    <!-- Info Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">â„¹ï¸ Info</span>
        </div>
        <p class="text-muted" style="font-size: 0.9rem; line-height: 1.6;">
            Ãœbe alle 11 Kalkulationsaufgaben aus Lernfeld 17.2. 
            Dein Fortschritt wird gespeichert, auch wenn du die App schlieÃŸt.
        </p>
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
            <span class="badge">âœ“ Offline verfÃ¼gbar</span>
            <span class="badge">âœ“ Fortschritt speichern</span>
            <span class="badge">âœ“ Zufallsaufgaben</span>
        </div>
    </div>

    <!-- Install Prompt -->
    <div class="card" id="installCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">ğŸ“± Als App installieren</span>
        </div>
        <p class="text-muted mb-2" style="font-size: 0.9rem;">
            Installiere die App auf deinem Homescreen fÃ¼r schnellen Zugriff!
        </p>
        <button type="button" class="btn btn-secondary btn-block" id="installBtn">
            â¬‡ï¸ Installieren
        </button>
    </div>

</div>

<!-- Modal fÃ¼r Profil-Konflikt -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ğŸ‘¤ Profil gefunden</h3>
            <button type="button" class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="mb-2">Ein Profil mit diesem Namen existiert bereits:</p>
            <div class="profile-item" style="cursor: default; margin-bottom: 16px;">
                <div class="profile-avatar" id="modalAvatar">ğŸ‘¤</div>
                <div class="profile-info">
                    <div class="profile-name" id="modalName">Name</div>
                    <div class="profile-stats" id="modalStats">0 Aufgaben gelÃ¶st</div>
                </div>
            </div>
            <p class="text-muted">MÃ¶chtest du dieses Profil laden oder einen anderen Namen wÃ¤hlen?</p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px;">
            <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">
                Anderen Namen
            </button>
            <button type="button" class="btn btn-primary" style="flex: 1;" id="loadProfileBtn">
                Profil laden
            </button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="./js/profanity.js"></script>
<script src="./js/profiles.js"></script>
<script src="./js/generator.js"></script>
<script>
// PWA Service Worker registrieren
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./js/sw.js')
        .then(reg => console.log('Service Worker registriert'))
        .catch(err => console.log('SW Fehler:', err));
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installCard').style.display = 'block';
});

document.getElementById('installBtn')?.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('installCard').style.display = 'none';
    }
});

// Elemente
const nameInput = document.getElementById('nameInput');
const nameError = document.getElementById('nameError');
const errorText = document.getElementById('errorText');
const profilesCard = document.getElementById('profilesCard');
const profileList = document.getElementById('profileList');

// Aktives Profil prÃ¼fen
const currentProfile = PROFILES.getCurrent();
if (currentProfile) {
    // Direkt zum Home weiterleiten
    window.location.href = './home.html';
}

// Vorhandene Profile laden
function loadProfiles() {
    const profiles = PROFILES.list();
    
    if (profiles.length > 0) {
        profilesCard.style.display = 'block';
        profileList.innerHTML = '';
        
        profiles.forEach(profile => {
            const li = document.createElement('li');
            li.className = 'profile-item';
            li.onclick = () => loginProfile(profile.name);
            
            const avatars = ['ğŸ‘¤', 'ğŸ“', 'ğŸ“š', 'ğŸ’ª', 'ğŸ¯', 'â­'];
            const avatar = avatars[profile.name.length % avatars.length];
            
            li.innerHTML = `
                <div class="profile-avatar">${avatar}</div>
                <div class="profile-info">
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-stats">${profile.solved}/11 gelÃ¶st Â· Streak: ${profile.bestStreak}</div>
                </div>
            `;
            
            profileList.appendChild(li);
        });
    }
}

// Profil einloggen
function loginProfile(name) {
    const result = PROFILES.login(name);
    if (result.success) {
        window.location.href = './home.html';
    }
}

// Start-Button Handler
function handleStart() {
    const name = nameInput.value.trim();
    
    // Validierung
    const validation = PROFANITY.validate(name);
    if (!validation.valid) {
        showError(validation.error);
        return;
    }
    
    // PrÃ¼fen ob Name existiert
    const existingName = PROFILES.exists(name);
    if (existingName) {
        showProfileModal(existingName);
        return;
    }
    
    // Neues Profil erstellen
    const result = PROFILES.create(name);
    if (result.success) {
        window.location.href = './home.html';
    } else {
        showError(result.error);
    }
}

// Fehler anzeigen
function showError(message) {
    nameError.style.display = 'flex';
    errorText.textContent = message;
    nameInput.classList.add('error');
    
    // Animation
    nameInput.style.animation = 'none';
    setTimeout(() => {
        nameInput.style.animation = 'shake 0.5s ease';
    }, 10);
}

// Fehler ausblenden
function hideError() {
    nameError.style.display = 'none';
    nameInput.classList.remove('error');
}

// Profil-Konflikt Modal anzeigen
function showProfileModal(name) {
    const profiles = PROFILES.loadAll();
    const profile = profiles[name];
    
    const avatars = ['ğŸ‘¤', 'ğŸ“', 'ğŸ“š', 'ğŸ’ª', 'ğŸ¯', 'â­'];
    document.getElementById('modalAvatar').textContent = avatars[name.length % avatars.length];
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalStats').textContent = 
        `${profile.solvedTasks.length}/11 gelÃ¶st Â· Beste Serie: ${profile.bestStreak}`;
    
    document.getElementById('loadProfileBtn').onclick = () => {
        loginProfile(name);
    };
    
    document.getElementById('modalOverlay').classList.add('show');
}

// Modal schlieÃŸen
function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
    nameInput.focus();
    nameInput.select();
}

// Event Listeners
nameInput.addEventListener('input', hideError);

nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        handleStart();
    }
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') {
        closeModal();
    }
});

// CSS Animation fÃ¼r Shake
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
`;
document.head.appendChild(style);

// Init
loadProfiles();
nameInput.focus();
</script>

</body>
</html>
