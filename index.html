<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalkulations-Trainer | Anmelden</title>
    <meta name="description" content="√úbungsapp f√ºr Preiskalkulation H√∂rakustik - Lernfeld 17.2">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="./icons/icon.svg">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<!-- Loading Screen -->
<div id="loadingScreen" style="position: fixed; inset: 0; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <div style="text-align: center;">
        <div style="font-size: 3rem; animation: pulse 1s infinite;">üìä</div>
        <p style="color: var(--text-muted); margin-top: 16px;">Wird geladen...</p>
    </div>
</div>

<div class="container" id="mainContainer" style="display: none;">

    <!-- Header -->
    <div class="header">
        <div class="header-icon">
            <svg class="icon icon-2xl" style="color: var(--accent);" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="8" y1="10" x2="8" y2="10"></line><line x1="12" y1="10" x2="12" y2="10"></line><line x1="16" y1="10" x2="16" y2="10"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="18" x2="8" y2="18"></line></svg>
        </div>
        <h1>Kalkulations-Trainer</h1>
        <p>Lernfeld 17.2 ¬∑ H√∂rakustik</p>
    </div>

    <!-- Storage Warning -->
    <div class="card" id="storageWarning" style="display: none; background: linear-gradient(135deg, rgba(255,165,0,0.2), rgba(255,165,0,0.1)); border-color: var(--warning);">
        <div class="card-header">
            <span class="card-title" style="color: var(--warning);">‚ö†Ô∏è Speicher-Hinweis</span>
        </div>
        <p class="text-muted" style="font-size: 0.9rem; line-height: 1.6;" id="storageWarningText">
        </p>
    </div>

    <!-- Login Card -->
    <div class="card" id="loginCard">
        <div class="card-header">
            <span class="card-title">Willkommen</span>
        </div>
        
        <p class="text-muted mb-2">
            Gib deinen Namen ein, um zu starten oder dein Profil zu laden.
        </p>

        <div class="input-group">
            <label class="input-label" for="nameInput">Dein Name</label>
            <input 
                type="text" 
                id="nameInput" 
                class="input-field" 
                placeholder="z.B. Max"
                maxlength="20"
                autocomplete="off"
                autocapitalize="words"
            >
            <div class="input-error" id="nameError" style="display: none;">
                <span>‚ö†Ô∏è</span>
                <span id="errorText"></span>
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-block btn-lg" id="startBtn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path></svg>
            Los geht's
        </button>
    </div>

    <!-- Existing Profiles -->
    <div class="card" id="profilesCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">Vorhandene Profile</span>
        </div>
        
        <ul class="profile-list" id="profileList">
        </ul>
    </div>

    <!-- Info Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                Info
            </span>
        </div>
        <p class="text-muted" style="font-size: 0.9rem; line-height: 1.6;">
            √úbe alle 11 Kalkulationsaufgaben aus Lernfeld 17.2. 
            Dein Fortschritt wird gespeichert, auch wenn du die App schlie√üt.
        </p>
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
            <span class="badge" id="storageBadge">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Speichern
            </span>
            <span class="badge">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Zufallsaufgaben
            </span>
        </div>
    </div>

    <!-- Install Prompt -->
    <div class="card" id="installCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Als App installieren
            </span>
        </div>
        <p class="text-muted mb-2" style="font-size: 0.9rem;">
            Installiere die App auf deinem Homescreen f√ºr schnellen Zugriff!
        </p>
        <button type="button" class="btn btn-secondary btn-block" id="installBtn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Installieren
        </button>
    </div>

</div>

<!-- Modal f√ºr Profil-Konflikt -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3>üë§ Profil gefunden</h3>
            <button type="button" class="modal-close" id="modalCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
            <p class="mb-2">Ein Profil mit diesem Namen existiert bereits:</p>
            <div class="profile-item" style="cursor: default; margin-bottom: 16px;">
                <div class="profile-avatar" id="modalAvatar">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="modalName">Name</div>
                    <div class="profile-stats" id="modalStats">0 Aufgaben gel√∂st</div>
                </div>
            </div>
            <p class="text-muted">M√∂chtest du dieses Profil laden oder einen anderen Namen w√§hlen?</p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px;">
            <button type="button" class="btn btn-secondary" style="flex: 1;" id="modalCancelBtn">
                Anderen Namen
            </button>
            <button type="button" class="btn btn-primary" style="flex: 1;" id="loadProfileBtn">
                Profil laden
            </button>
        </div>
    </div>
</div>

<!-- Scripts - storage.js MUST come before profiles.js -->
<script src="./js/storage.js?v=7"></script>
<script src="./js/profanity.js?v=7"></script>
<script src="./js/profiles.js?v=7"></script>
<script src="./js/generator.js?v=7"></script>
<script>
// ===== APP INITIALIZATION =====

// PWA Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./js/sw.js')
        .then(reg => console.log('SW registriert'))
        .catch(err => console.log('SW Fehler:', err));
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installCard').style.display = 'block';
});

document.getElementById('installBtn')?.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('installCard').style.display = 'none';
    }
});

// CSS Animation
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
`;
document.head.appendChild(style);

// ===== MAIN APP =====

// DOM Elements
const nameInput = document.getElementById('nameInput');
const nameError = document.getElementById('nameError');
const errorText = document.getElementById('errorText');
const profilesCard = document.getElementById('profilesCard');
const profileList = document.getElementById('profileList');
const loadingScreen = document.getElementById('loadingScreen');
const mainContainer = document.getElementById('mainContainer');
const storageWarning = document.getElementById('storageWarning');
const storageBadge = document.getElementById('storageBadge');

// Show error
function showError(message) {
    nameError.style.display = 'flex';
    errorText.textContent = message;
    nameInput.classList.add('error');
    nameInput.style.animation = 'none';
    setTimeout(() => { nameInput.style.animation = 'shake 0.5s ease'; }, 10);
}

// Hide error
function hideError() {
    nameError.style.display = 'none';
    nameInput.classList.remove('error');
}

// Close modal
function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
    nameInput.focus();
    nameInput.select();
}

// Show profile modal
function showProfileModal(name) {
    const profiles = PROFILES.loadAll();
    const profile = profiles[name];
    
    const avatars = ['üë§', 'üéì', 'üìö', 'üí™', 'üéØ', '‚≠ê'];
    document.getElementById('modalAvatar').textContent = avatars[name.length % avatars.length];
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalStats').textContent = 
        `${profile.solvedTasks.length}/11 gel√∂st ¬∑ Beste Serie: ${profile.bestStreak}`;
    
    document.getElementById('loadProfileBtn').onclick = () => loginProfile(name);
    document.getElementById('modalOverlay').classList.add('show');
}

// Login profile
async function loginProfile(name) {
    const result = await PROFILES.login(name);
    if (result.success) {
        window.location.href = './kurs.html';
    }
}

// Load profiles list
function loadProfilesList() {
    const profiles = PROFILES.list();
    
    if (profiles.length > 0) {
        profilesCard.style.display = 'block';
        profileList.innerHTML = '';
        
        profiles.forEach(profile => {
            const li = document.createElement('li');
            li.className = 'profile-item';
            li.onclick = () => loginProfile(profile.name);
            
            const avatars = ['üë§', 'üéì', 'üìö', 'üí™', 'üéØ', '‚≠ê'];
            const avatar = avatars[profile.name.length % avatars.length];
            
            li.innerHTML = `
                <div class="profile-avatar">${avatar}</div>
                <div class="profile-info">
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-stats">${profile.solved}/11 gel√∂st ¬∑ Streak: ${profile.bestStreak}</div>
                </div>
            `;
            
            profileList.appendChild(li);
        });
    }
}

// Start button handler
async function handleStart() {
    const name = nameInput.value.trim();
    
    // Validation
    const validation = PROFANITY.validate(name);
    if (!validation.valid) {
        showError(validation.error);
        return;
    }
    
    // Check if name exists
    const existingName = PROFILES.exists(name);
    if (existingName) {
        showProfileModal(existingName);
        return;
    }
    
    // Create new profile
    const result = await PROFILES.create(name);
    if (result.success) {
        if (result.warning) {
            alert('‚ö†Ô∏è ' + result.warning);
        }
        window.location.href = './kurs.html';
    } else {
        showError(result.error);
    }
}

// Event Listeners
nameInput.addEventListener('input', hideError);
nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleStart();
});
document.getElementById('startBtn').addEventListener('click', handleStart);
document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
});

// ===== INITIALIZE APP =====
async function initApp() {
    console.log('üöÄ Initialisiere App...');
    
    // Wait for storage to be ready
    STORAGE.onReady(async () => {
        console.log('üì¶ Storage bereit:', STORAGE.getType());
        
        // Initialize profiles
        await PROFILES.init();
        
        // Check storage status
        const status = STORAGE.getStatus();
        console.log('üìä Storage Status:', status);
        
        // Show warning if not persistent
        if (!status.persistent) {
            storageWarning.style.display = 'block';
            storageBadge.textContent = '‚ö†Ô∏è Tempor√§r';
            storageBadge.style.background = 'var(--warning)';
            storageBadge.style.color = 'var(--bg-dark)';
            
            if (status.type === 'sessionStorage') {
                document.getElementById('storageWarningText').innerHTML = 
                    '<strong>Daten werden nur tempor√§r gespeichert.</strong><br><br>' +
                    'Dein Fortschritt geht verloren wenn du den Browser schlie√üt.<br><br>' +
                    '<strong>F√ºr dauerhafte Speicherung:</strong><br>' +
                    '‚Ä¢ √ñffne in Safari (nicht im privaten Modus)<br>' +
                    '‚Ä¢ Einstellungen ‚Üí Safari ‚Üí "Alle Cookies blockieren" deaktivieren';
            } else if (status.type === 'memory') {
                document.getElementById('storageWarningText').innerHTML = 
                    '<strong>Speichern nicht m√∂glich!</strong><br><br>' +
                    'Dein Browser blockiert alle Speichermethoden.<br><br>' +
                    '<strong>Bitte versuche:</strong><br>' +
                    '‚Ä¢ Safari/Chrome √∂ffnen (nicht WhatsApp/Instagram)<br>' +
                    '‚Ä¢ Privaten Modus deaktivieren<br>' +
                    '‚Ä¢ Cookies erlauben';
            }
        } else if (status.type === 'indexedDB') {
            storageBadge.textContent = '‚úì IndexedDB';
        }
        
        // Check for existing session
        const currentProfile = PROFILES.getCurrent();
        if (currentProfile) {
            console.log('üë§ Aktives Profil gefunden:', currentProfile.name);
            window.location.href = './kurs.html';
            return;
        }
        
        // Load profiles list
        loadProfilesList();
        
        // Hide loading, show main
        loadingScreen.style.display = 'none';
        mainContainer.style.display = 'block';
        nameInput.focus();
        
        console.log('‚úÖ App bereit!');
    });
}

// Start the app
initApp();
</script>

</body>
</html>
