<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalkulations-Trainer | Anmelden</title>
    <meta name="description" content="Ãœbungsapp fÃ¼r Preiskalkulation HÃ¶rakustik - Lernfeld 17.2">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="./icons/icon.svg">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<!-- Loading Screen -->
<div id="loadingScreen" style="position: fixed; inset: 0; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <div style="text-align: center;">
        <div style="font-size: 3rem; animation: pulse 1s infinite;">ğŸ“Š</div>
        <p style="color: var(--text-muted); margin-top: 16px;">Wird geladen...</p>
    </div>
</div>

<div class="container" id="mainContainer" style="display: none;">

    <!-- Header -->
    <div class="header">
        <div class="header-icon">ğŸ“Š</div>
        <h1>Kalkulations-Trainer</h1>
        <p>Lernfeld 17.2 Â· HÃ¶rakustik</p>
    </div>

    <!-- Storage Warning -->
    <div class="card" id="storageWarning" style="display: none; background: linear-gradient(135deg, rgba(255,165,0,0.2), rgba(255,165,0,0.1)); border-color: var(--warning);">
        <div class="card-header">
            <span class="card-title" style="color: var(--warning);">âš ï¸ Speicher-Hinweis</span>
        </div>
        <p class="text-muted" style="font-size: 0.9rem; line-height: 1.6;" id="storageWarningText">
        </p>
    </div>

    <!-- Login Card -->
    <div class="card" id="loginCard">
        <div class="card-header">
            <span class="card-title">Willkommen</span>
        </div>
        
        <p class="text-muted mb-2">
            Gib deinen Namen ein, um zu starten oder dein Profil zu laden.
        </p>

        <div class="input-group">
            <label class="input-label" for="nameInput">Dein Name</label>
            <input 
                type="text" 
                id="nameInput" 
                class="input-field" 
                placeholder="z.B. Max"
                maxlength="20"
                autocomplete="off"
                autocapitalize="words"
            >
            <div class="input-error" id="nameError" style="display: none;">
                <span>âš ï¸</span>
                <span id="errorText"></span>
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-block btn-lg" id="startBtn">
            ğŸš€ Los geht's
        </button>
    </div>

    <!-- Existing Profiles -->
    <div class="card" id="profilesCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">Vorhandene Profile</span>
        </div>
        
        <ul class="profile-list" id="profileList">
        </ul>
    </div>

    <!-- Info Card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">â„¹ï¸ Info</span>
        </div>
        <p class="text-muted" style="font-size: 0.9rem; line-height: 1.6;">
            Ãœbe alle 11 Kalkulationsaufgaben aus Lernfeld 17.2. 
            Dein Fortschritt wird gespeichert, auch wenn du die App schlieÃŸt.
        </p>
        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
            <span class="badge" id="storageBadge">âœ“ Speichern mÃ¶glich</span>
            <span class="badge">âœ“ Zufallsaufgaben</span>
        </div>
    </div>

    <!-- Install Prompt -->
    <div class="card" id="installCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">ğŸ“± Als App installieren</span>
        </div>
        <p class="text-muted mb-2" style="font-size: 0.9rem;">
            Installiere die App auf deinem Homescreen fÃ¼r schnellen Zugriff!
        </p>
        <button type="button" class="btn btn-secondary btn-block" id="installBtn">
            â¬‡ï¸ Installieren
        </button>
    </div>

</div>

<!-- Modal fÃ¼r Profil-Konflikt -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3>ğŸ‘¤ Profil gefunden</h3>
            <button type="button" class="modal-close" id="modalCloseBtn">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="mb-2">Ein Profil mit diesem Namen existiert bereits:</p>
            <div class="profile-item" style="cursor: default; margin-bottom: 16px;">
                <div class="profile-avatar" id="modalAvatar">ğŸ‘¤</div>
                <div class="profile-info">
                    <div class="profile-name" id="modalName">Name</div>
                    <div class="profile-stats" id="modalStats">0 Aufgaben gelÃ¶st</div>
                </div>
            </div>
            <p class="text-muted">MÃ¶chtest du dieses Profil laden oder einen anderen Namen wÃ¤hlen?</p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px;">
            <button type="button" class="btn btn-secondary" style="flex: 1;" id="modalCancelBtn">
                Anderen Namen
            </button>
            <button type="button" class="btn btn-primary" style="flex: 1;" id="loadProfileBtn">
                Profil laden
            </button>
        </div>
    </div>
</div>

<!-- Scripts - storage.js MUST come before profiles.js -->
<script src="./js/storage.js"></script>
<script src="./js/profanity.js"></script>
<script src="./js/profiles.js"></script>
<script src="./js/generator.js"></script>
<script>
// ===== APP INITIALIZATION =====

// PWA Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./js/sw.js')
        .then(reg => console.log('SW registriert'))
        .catch(err => console.log('SW Fehler:', err));
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installCard').style.display = 'block';
});

document.getElementById('installBtn')?.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById('installCard').style.display = 'none';
    }
});

// CSS Animation
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
`;
document.head.appendChild(style);

// ===== MAIN APP =====

// DOM Elements
const nameInput = document.getElementById('nameInput');
const nameError = document.getElementById('nameError');
const errorText = document.getElementById('errorText');
const profilesCard = document.getElementById('profilesCard');
const profileList = document.getElementById('profileList');
const loadingScreen = document.getElementById('loadingScreen');
const mainContainer = document.getElementById('mainContainer');
const storageWarning = document.getElementById('storageWarning');
const storageBadge = document.getElementById('storageBadge');

// Show error
function showError(message) {
    nameError.style.display = 'flex';
    errorText.textContent = message;
    nameInput.classList.add('error');
    nameInput.style.animation = 'none';
    setTimeout(() => { nameInput.style.animation = 'shake 0.5s ease'; }, 10);
}

// Hide error
function hideError() {
    nameError.style.display = 'none';
    nameInput.classList.remove('error');
}

// Close modal
function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
    nameInput.focus();
    nameInput.select();
}

// Show profile modal
function showProfileModal(name) {
    const profiles = PROFILES.loadAll();
    const profile = profiles[name];
    
    const avatars = ['ğŸ‘¤', 'ğŸ“', 'ğŸ“š', 'ğŸ’ª', 'ğŸ¯', 'â­'];
    document.getElementById('modalAvatar').textContent = avatars[name.length % avatars.length];
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalStats').textContent = 
        `${profile.solvedTasks.length}/11 gelÃ¶st Â· Beste Serie: ${profile.bestStreak}`;
    
    document.getElementById('loadProfileBtn').onclick = () => loginProfile(name);
    document.getElementById('modalOverlay').classList.add('show');
}

// Login profile
async function loginProfile(name) {
    const result = await PROFILES.login(name);
    if (result.success) {
        window.location.href = './home.html';
    }
}

// Load profiles list
function loadProfilesList() {
    const profiles = PROFILES.list();
    
    if (profiles.length > 0) {
        profilesCard.style.display = 'block';
        profileList.innerHTML = '';
        
        profiles.forEach(profile => {
            const li = document.createElement('li');
            li.className = 'profile-item';
            li.onclick = () => loginProfile(profile.name);
            
            const avatars = ['ğŸ‘¤', 'ğŸ“', 'ğŸ“š', 'ğŸ’ª', 'ğŸ¯', 'â­'];
            const avatar = avatars[profile.name.length % avatars.length];
            
            li.innerHTML = `
                <div class="profile-avatar">${avatar}</div>
                <div class="profile-info">
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-stats">${profile.solved}/11 gelÃ¶st Â· Streak: ${profile.bestStreak}</div>
                </div>
            `;
            
            profileList.appendChild(li);
        });
    }
}

// Start button handler
async function handleStart() {
    const name = nameInput.value.trim();
    
    // Validation
    const validation = PROFANITY.validate(name);
    if (!validation.valid) {
        showError(validation.error);
        return;
    }
    
    // Check if name exists
    const existingName = PROFILES.exists(name);
    if (existingName) {
        showProfileModal(existingName);
        return;
    }
    
    // Create new profile
    const result = await PROFILES.create(name);
    if (result.success) {
        if (result.warning) {
            alert('âš ï¸ ' + result.warning);
        }
        window.location.href = './home.html';
    } else {
        showError(result.error);
    }
}

// Event Listeners
nameInput.addEventListener('input', hideError);
nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleStart();
});
document.getElementById('startBtn').addEventListener('click', handleStart);
document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
});

// ===== INITIALIZE APP =====
async function initApp() {
    console.log('ğŸš€ Initialisiere App...');
    
    // Wait for storage to be ready
    STORAGE.onReady(async () => {
        console.log('ğŸ“¦ Storage bereit:', STORAGE.getType());
        
        // Initialize profiles
        await PROFILES.init();
        
        // Check storage status
        const status = STORAGE.getStatus();
        console.log('ğŸ“Š Storage Status:', status);
        
        // Show warning if not persistent
        if (!status.persistent) {
            storageWarning.style.display = 'block';
            storageBadge.textContent = 'âš ï¸ TemporÃ¤r';
            storageBadge.style.background = 'var(--warning)';
            storageBadge.style.color = 'var(--bg-dark)';
            
            if (status.type === 'sessionStorage') {
                document.getElementById('storageWarningText').innerHTML = 
                    '<strong>Daten werden nur temporÃ¤r gespeichert.</strong><br><br>' +
                    'Dein Fortschritt geht verloren wenn du den Browser schlieÃŸt.<br><br>' +
                    '<strong>FÃ¼r dauerhafte Speicherung:</strong><br>' +
                    'â€¢ Ã–ffne in Safari (nicht im privaten Modus)<br>' +
                    'â€¢ Einstellungen â†’ Safari â†’ "Alle Cookies blockieren" deaktivieren';
            } else if (status.type === 'memory') {
                document.getElementById('storageWarningText').innerHTML = 
                    '<strong>Speichern nicht mÃ¶glich!</strong><br><br>' +
                    'Dein Browser blockiert alle Speichermethoden.<br><br>' +
                    '<strong>Bitte versuche:</strong><br>' +
                    'â€¢ Safari/Chrome Ã¶ffnen (nicht WhatsApp/Instagram)<br>' +
                    'â€¢ Privaten Modus deaktivieren<br>' +
                    'â€¢ Cookies erlauben';
            }
        } else if (status.type === 'indexedDB') {
            storageBadge.textContent = 'âœ“ IndexedDB';
        }
        
        // Check for existing session
        const currentProfile = PROFILES.getCurrent();
        if (currentProfile) {
            console.log('ğŸ‘¤ Aktives Profil gefunden:', currentProfile.name);
            window.location.href = './home.html';
            return;
        }
        
        // Load profiles list
        loadProfilesList();
        
        // Hide loading, show main
        loadingScreen.style.display = 'none';
        mainContainer.style.display = 'block';
        nameInput.focus();
        
        console.log('âœ… App bereit!');
    });
}

// Start the app
initApp();
</script>

</body>
</html>
