<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ergebnis | Kalkulations-Trainer</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Result Hero -->
    <div class="card text-center" style="padding: 40px 20px;">
        <div id="heroIcon" style="font-size: 5rem; margin-bottom: 16px; animation: bounce 0.6s ease;">ðŸŽ‰</div>
        <h1 id="heroTitle" style="font-size: 1.75rem; margin-bottom: 8px;">Gut gemacht!</h1>
        <p class="text-muted" id="heroText">Du hast fleiÃŸig geÃ¼bt.</p>
    </div>

    <!-- Session Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Diese Session</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number text-success" id="statCorrect">0</div>
                <div class="stat-label">Richtig</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: var(--danger);" id="statWrong">0</div>
                <div class="stat-label">Falsch</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">Versucht</div>
            </div>
        </div>
    </div>

    <!-- Task List -->
    <div class="card" id="taskListCard" style="display: none;">
        <div class="card-header">
            <span class="card-title">Bearbeitete Aufgaben</span>
        </div>
        <ul id="taskList" style="list-style: none;"></ul>
    </div>

    <!-- Overall Progress -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Gesamtfortschritt</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalSolved">0</div>
                <div class="stat-label">Gemeistert</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRemaining">11</div>
                <div class="stat-label">Offen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStreak">0</div>
                <div class="stat-label">Beste Serie</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p class="text-center text-muted mt-1" id="progressText">0 von 11 Aufgaben gemeistert</p>
    </div>

    <!-- Actions -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <a href="./kurs.html" class="btn btn-secondary" style="text-decoration: none;">
            ðŸ“š Zum Kurs
        </a>
        <a href="./profil.html" class="btn btn-primary" style="text-decoration: none;">
            ðŸ‘¤ Zum Profil
        </a>
    </div>

    <!-- Tip Card -->
    <div class="card" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border-color: var(--warning);">
        <div class="card-header">
            <span class="card-title" style="color: var(--warning);">ðŸ’¡ Tipp</span>
        </div>
        <p class="text-muted" id="tipText" style="font-size: 0.9rem; line-height: 1.6;">
            Ãœbung macht den Meister!
        </p>
    </div>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="./kurs.html" class="nav-item">
        <svg class="icon" viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"></path></svg>
        <span>Kurs</span>
    </a>
    <a href="./profil.html" class="nav-item">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Profil</span>
    </a>
</nav>

<!-- Scripts -->
<script src="./js/storage.js?v=7"></script>
<script src="./js/profanity.js?v=7"></script>
<script src="./js/profiles.js?v=7"></script>
<script src="./js/generator.js?v=7"></script>
<script>
// Warten auf Storage + Profiles Init
STORAGE.onReady(async () => {
await PROFILES.init();

// Session-Daten laden
let session = null;
try {
    const data = sessionStorage.getItem('lastSession');
    if (data) {
        session = JSON.parse(data);
        sessionStorage.removeItem('lastSession');
    }
} catch (e) {}

if (!session) {
    session = { attempted: [], correct: [], wrong: [] };
}

// Profil-Stats
const stats = PROFILES.getStats();

// Session-Stats anzeigen
document.getElementById('statCorrect').textContent = session.correct.length;
document.getElementById('statWrong').textContent = session.wrong.length;
document.getElementById('statTotal').textContent = session.attempted.length;

// Hero basierend auf Ergebnis
const correctCount = session.correct.length;
const totalCount = session.attempted.length;
const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

const heroIcon = document.getElementById('heroIcon');
const heroTitle = document.getElementById('heroTitle');
const heroText = document.getElementById('heroText');

if (totalCount === 0) {
    heroIcon.textContent = 'ðŸ¤”';
    heroTitle.textContent = 'Keine Aufgaben bearbeitet';
    heroText.textContent = 'Starte eine neue Ãœbung, um zu trainieren!';
} else if (percentage === 100) {
    heroIcon.textContent = 'ðŸ†';
    heroTitle.textContent = 'Perfekt!';
    heroText.textContent = 'Alle ' + correctCount + ' Aufgaben richtig gelÃ¶st!';
} else if (percentage >= 80) {
    heroIcon.textContent = 'ðŸŽ‰';
    heroTitle.textContent = 'Sehr gut!';
    heroText.textContent = correctCount + ' von ' + totalCount + ' richtig (' + percentage + '%)';
} else if (percentage >= 50) {
    heroIcon.textContent = 'ðŸ‘';
    heroTitle.textContent = 'Gut gemacht!';
    heroText.textContent = correctCount + ' von ' + totalCount + ' richtig (' + percentage + '%)';
} else if (correctCount > 0) {
    heroIcon.textContent = 'ðŸ’ª';
    heroTitle.textContent = 'Weiter so!';
    heroText.textContent = correctCount + ' von ' + totalCount + ' richtig â€“ Ãœbung macht den Meister!';
} else {
    heroIcon.textContent = 'ðŸ“š';
    heroTitle.textContent = 'Nicht aufgeben!';
    heroText.textContent = 'Schau dir die Hilfe-Texte an und versuch es nochmal.';
}

// Task-Liste
if (session.attempted.length > 0) {
    document.getElementById('taskListCard').style.display = 'block';
    const taskList = document.getElementById('taskList');
    
    session.attempted.forEach(taskId => {
        const task = GENERATOR.getOriginal(taskId);
        const isCorrect = session.correct.includes(taskId);
        const isWrong = session.wrong.includes(taskId);
        
        const li = document.createElement('li');
        li.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--glass-border);';
        
        const iconClass = isCorrect ? 'success' : (isWrong ? '' : '');
        const iconBg = isCorrect ? 'var(--success)' : (isWrong ? 'var(--danger)' : 'var(--glass-bg)');
        const icon = isCorrect ? 'âœ“' : (isWrong ? 'âœ—' : 'â€“');
        
        li.innerHTML = `
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${iconBg}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                ${icon}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: 600;">Aufgabe ${taskId}</div>
                <div class="text-muted" style="font-size: 0.8rem;">${task ? task.name : ''}</div>
            </div>
        `;
        
        taskList.appendChild(li);
    });
}

// Gesamtfortschritt
if (stats) {
    const solved = stats.solved;
    const remaining = 11 - solved;
    const progress = Math.round((solved / 11) * 100);
    
    document.getElementById('totalSolved').textContent = solved;
    document.getElementById('totalRemaining').textContent = remaining;
    document.getElementById('totalStreak').textContent = stats.bestStreak;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = solved + ' von 11 Aufgaben gemeistert';
}

// Tipps
const tips = [
    'Bei MEK zuerst Porto addieren, dann MGK-Zuschlag!',
    'Handelswaren haben einen MGK von 108%, nicht 35,4%!',
    'Arbeitszeit: Minuten durch 60 teilen, dann mal Stundensatz.',
    'RÃ¼ckrechnungen: Vom Brutto schrittweise zurÃ¼ck rechnen.',
    'Nutze die (?)-Buttons fÃ¼r ErklÃ¤rungen zu jedem Schritt!',
    'Bei Skonto: Erst Rabatt abziehen, dann Skonto berechnen!',
    'Aufgabe 6 hat zwei verschiedene Arbeitszeiten!',
    'Der Zufallsmodus hilft, die Konzepte besser zu verstehen.',
    'Du schaffst das! Morgen in der PrÃ¼fung wirst du glÃ¤nzen! ðŸ’ª',
    'Kleine Schritte fÃ¼hren zum groÃŸen Erfolg!'
];

document.getElementById('tipText').textContent = tips[Math.floor(Math.random() * tips.length)];

// Konfetti-Effekt bei 100%
if (percentage === 100 && totalCount > 0) {
    // Simple confetti animation with CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 1000;
            animation: confetti 3s linear forwards;
        }
    `;
    document.head.appendChild(style);
    
    const colors = ['#00f5d4', '#ffd700', '#ff4757', '#00cc88', '#8b5cf6'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 5000);
    }
}

}); // Ende STORAGE.onReady
</script>

</body>
</html>
