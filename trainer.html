<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√úbung | Kalkulations-Trainer</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Header -->
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
        <a href="./home.html" class="btn btn-secondary" style="padding: 12px; border-radius: 50%;">
            ‚Üê
        </a>
        <div style="flex: 1;">
            <h1 style="font-size: 1.25rem; margin-bottom: 2px;">√úbung</h1>
            <p class="text-muted" style="font-size: 0.85rem;" id="sessionInfo">W√§hle eine Aufgabe</p>
        </div>
        <span class="badge" id="modeBadge">Original</span>
    </div>

    <!-- Mode Toggle -->
    <div class="card">
        <div class="toggle-container">
            <span class="toggle-label">üîÄ Zufallszahlen verwenden</span>
            <label class="toggle">
                <input type="checkbox" id="randomMode" onchange="toggleRandomMode()">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <!-- Task Selection -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Aufgabe w√§hlen</span>
            <button type="button" class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.8rem;" onclick="regenerateTask()">
                üîÑ Neue Zahlen
            </button>
        </div>
        <div class="task-grid" id="taskGrid"></div>
    </div>

    <!-- Task Info -->
    <div class="info-card" id="infoCard">
        <div class="info-card-header">
            <div style="flex: 1;">
                <h3 id="infoTitle">Aufgabe</h3>
                <p id="infoText" style="margin-top: 8px;"></p>
                <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                    <span class="badge" id="infoBadge">Vorw√§rts</span>
                    <span class="badge random" id="randomBadge" style="display: none;">üîÄ Zufallswerte</span>
                </div>
            </div>
            <button type="button" class="help-btn" onclick="showTaskHelp()" style="width: 40px; height: 40px; font-size: 1.2rem;">?</button>
        </div>
    </div>

    <!-- Result Card -->
    <div class="result-card" id="resultCard">
        <div class="result-icon" id="resultIcon">‚úÖ</div>
        <h3 id="resultTitle">Richtig!</h3>
        <p id="resultText">Super gemacht!</p>
        <div id="resultValues" style="display: flex; justify-content: center; gap: 32px; margin-top: 16px;"></div>
    </div>

    <!-- Calculator -->
    <div class="card" id="calcCard">
        
        <!-- MEK Section -->
        <div class="calc-row highlight">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üì¶</span> Listenpreis / Einkaufspreis
                </div>
                <button type="button" class="help-btn" onclick="showHelp('mek')">?</button>
            </div>
            <div class="input-row">
                <div class="input-box">
                    <input type="number" id="mek" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
            </div>
        </div>

        <div class="calc-row highlight">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üì¨</span> + Bezugskosten (Porto)
                </div>
                <button type="button" class="help-btn" onclick="showHelp('mek')">?</button>
            </div>
            <div class="row-hint warning">‚ö†Ô∏è ZUERST addieren, DANN Zuschlag!</div>
            <div class="input-row">
                <div class="input-box">
                    <input type="number" id="porto" step="0.01" value="0" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
            </div>
        </div>

        <div class="calc-row sum">
            <div class="row-header">
                <div class="row-label">= Materialeinzelkosten (MEK)</div>
                <button type="button" class="help-btn" onclick="showHelp('mek')">?</button>
            </div>
            <div class="calc-result" id="resMek">0,00 ‚Ç¨</div>
        </div>

        <!-- MGK -->
        <div class="calc-row">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üìä</span> + Materialgemeinkosten (MGK)
                </div>
                <button type="button" class="help-btn" onclick="showHelp('mgk')">?</button>
            </div>
            <div class="row-hint">Zuschlagssatz auf MEK</div>
            <div class="input-row">
                <div class="input-box small">
                    <input type="number" id="mgk" step="0.1" value="35.4" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
                <span class="text-muted">‚Üí</span>
                <span class="calc-result computed" id="resMgk">0,00 ‚Ç¨</span>
            </div>
        </div>

        <div class="calc-row sum">
            <div class="row-header">
                <div class="row-label">= Materialgesamtkosten (Mges)</div>
            </div>
            <div class="calc-result" id="resMges">0,00 ‚Ç¨</div>
        </div>

        <!-- Fertigung 1 -->
        <div class="calc-row">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">‚è±Ô∏è</span> + Fertigungskosten
                </div>
                <button type="button" class="help-btn" onclick="showHelp('fert')">?</button>
            </div>
            <div class="row-hint">Minuten √∑ 60 √ó Stundensatz</div>
            <div class="input-row">
                <div class="input-box small">
                    <input type="number" id="min1" value="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                <span class="text-muted">√ó</span>
                <div class="input-box small">
                    <input type="number" id="rate1" step="0.01" value="58.90" inputmode="decimal">
                    <span class="unit">‚Ç¨/h</span>
                </div>
            </div>
            <div class="calc-result computed" id="resFert1">0,00 ‚Ç¨</div>
        </div>

        <!-- Fertigung 2 -->
        <div class="calc-row" id="fert2Row" style="display: none;">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">‚è±Ô∏è</span> + Weitere Arbeitszeit
                </div>
            </div>
            <div class="input-row">
                <div class="input-box small">
                    <input type="number" id="min2" value="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                <span class="text-muted">√ó</span>
                <div class="input-box small">
                    <input type="number" id="rate2" step="0.01" value="60.50" inputmode="decimal">
                    <span class="unit">‚Ç¨/h</span>
                </div>
            </div>
            <div class="calc-result computed" id="resFert2">0,00 ‚Ç¨</div>
        </div>

        <!-- Pauschale -->
        <div class="calc-row">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üîß</span> + Pauschale
                </div>
                <button type="button" class="help-btn" onclick="showHelp('pausch')">?</button>
            </div>
            <div class="row-hint">Reinigung, Abformung, etc.</div>
            <div class="input-row">
                <div class="input-box">
                    <input type="number" id="pausch" step="0.01" value="0" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
            </div>
        </div>

        <div class="calc-row sum">
            <div class="row-header">
                <div class="row-label">= Selbstkosten (Sk)</div>
                <button type="button" class="help-btn" onclick="showHelp('sk')">?</button>
            </div>
            <div class="calc-result" id="resSk">0,00 ‚Ç¨</div>
        </div>

        <!-- Gewinn -->
        <div class="calc-row">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üí∞</span> + Gewinn
                </div>
                <button type="button" class="help-btn" onclick="showHelp('gewinn')">?</button>
            </div>
            <div class="input-row">
                <div class="input-box small">
                    <input type="number" id="gewinn" step="0.1" placeholder="0" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
                <span class="text-muted">‚Üí</span>
                <span class="calc-result computed" id="resGewinn">0,00 ‚Ç¨</span>
            </div>
        </div>

        <div class="calc-row sum">
            <div class="row-header">
                <div class="row-label">= Nettoverkaufspreis (NVP)</div>
                <button type="button" class="help-btn" onclick="showHelp('nvp')">?</button>
            </div>
            <div class="calc-result" id="resNvp">0,00 ‚Ç¨</div>
        </div>

        <!-- MwSt -->
        <div class="calc-row">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üèõÔ∏è</span> + Mehrwertsteuer (19%)
                </div>
                <button type="button" class="help-btn" onclick="showHelp('mwst')">?</button>
            </div>
            <div class="calc-result computed" id="resMwst">0,00 ‚Ç¨</div>
        </div>

        <div class="calc-row final">
            <div class="row-header">
                <div class="row-label">
                    <span class="icon">üéØ</span> = Bruttoverkaufspreis (BVP)
                </div>
            </div>
            <div class="calc-result" id="resBvp">0,00 ‚Ç¨</div>
        </div>
    </div>

    <!-- Actions -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
        <button type="button" class="btn btn-secondary" onclick="resetCalc()">
            üîÑ Zur√ºcksetzen
        </button>
        <button type="button" class="btn btn-primary" onclick="checkResult()">
            ‚úì Pr√ºfen
        </button>
    </div>

    <a href="./ergebnis.html" class="btn btn-success btn-block" onclick="endSession()" style="text-decoration: none;">
        üèÅ √úbung beenden
    </a>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="./home.html" class="nav-item">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>
    <a href="./trainer.html" class="nav-item active">
        <span class="icon">üìä</span>
        <span>√úben</span>
    </a>
    <a href="./profil.html" class="nav-item">
        <span class="icon">üë§</span>
        <span>Profil</span>
    </a>
</nav>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">‚ÑπÔ∏è Hilfe</h3>
            <button type="button" class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-block" onclick="closeModal()">Verstanden</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="./js/storage.js?v=6"></script>
<script src="./js/profanity.js?v=6"></script>
<script src="./js/profiles.js?v=6"></script>
<script src="./js/generator.js?v=6"></script>
<script src="./js/icons.js?v=6"></script>
<script>
// Warten auf Storage + Profiles Init
STORAGE.onReady(async () => {
await PROFILES.init();

// Profil pr√ºfen
const profile = PROFILES.getCurrent();
if (!profile) {
    window.location.href = './index.html';
    return;
}

// State
let currentTask = null;
let currentTaskData = null;
let isRandomMode = false;
let session = { attempted: [], correct: [], wrong: [] };

// Hilfe-Texte
const HELP = {
    mek: {
        title: "Materialeinzelkosten (MEK)",
        text: "Die MEK sind der Einkaufspreis des Materials PLUS alle Bezugskosten (Porto, Transport, Verpackung).",
        details: ["Erst alle Kosten zusammenrechnen", "DANN kommt der MGK-Zuschlag", "H√§ufiger Fehler: Porto vergessen!"]
    },
    mgk: {
        title: "Materialgemeinkosten (MGK)",
        text: "Der MGK-Zuschlag deckt alle Gemeinkosten ab (Lager, Verwaltung, etc.).",
        details: ["H√∂rger√§te: 32,8%", "Otoplastik/Material: 35,4%", "Handelswaren: 108%"]
    },
    fert: {
        title: "Fertigungskosten",
        text: "Die Kosten f√ºr die Arbeitszeit.",
        details: ["Formel: (Minuten √∑ 60) √ó Stundensatz", "HG-Anpassung: 60,50 ‚Ç¨/h", "Audiometrie: 63,40 ‚Ç¨/h", "Werkstatt: 58,90 ‚Ç¨/h"]
    },
    pausch: {
        title: "Pauschalen",
        text: "Feste Betr√§ge f√ºr bestimmte Leistungen.",
        details: ["Werden direkt in Euro angegeben", "Beispiel: Reinigung 6,95‚Ç¨", "Zu Fertigungskosten addieren"]
    },
    sk: {
        title: "Selbstkosten (Sk)",
        text: "Alle Kosten f√ºr Herstellung/Beschaffung ‚Äì ohne Gewinn!",
        details: ["Sk = Mges + Fertigungskosten", "= 100% bei Gewinnberechnung"]
    },
    gewinn: {
        title: "Gewinn",
        text: "Der Aufschlag auf die Selbstkosten.",
        details: ["Wird in Prozent angegeben", "Berechnung: Sk √ó Gewinn%"]
    },
    nvp: {
        title: "Nettoverkaufspreis (NVP)",
        text: "Der Preis ohne Mehrwertsteuer.",
        details: ["NVP = Sk + Gewinn", "= 100% f√ºr MwSt-Berechnung"]
    },
    mwst: {
        title: "Mehrwertsteuer (MwSt)",
        text: "Die gesetzliche Steuer von 19%.",
        details: ["Immer 19% auf NVP", "Berechnung: NVP √ó 0,19"]
    },
    bvp: {
        title: "Bruttoverkaufspreis (BVP)",
        text: "Der Endpreis inklusive MwSt.",
        details: ["BVP = NVP √ó 1,19", "Das ist der Preis auf dem Preisschild!"]
    }
};

// Euro-Formatierung
function eur(n) {
    return n.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
}

// Task-Grid erstellen
function initTaskGrid() {
    const grid = document.getElementById('taskGrid');
    const stats = PROFILES.getStats();
    
    GENERATOR.getAllTaskIds().forEach(id => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'task-btn';
        btn.id = 'task' + id;
        btn.innerHTML = '<span>' + id + '</span>';
        btn.onclick = () => loadTask(id);
        
        if (stats.solvedTasks.includes(id)) {
            btn.classList.add('solved');
        }
        
        grid.appendChild(btn);
    });
    
    // Random Button
    const randomBtn = document.createElement('button');
    randomBtn.type = 'button';
    randomBtn.className = 'task-btn random';
    randomBtn.innerHTML = '<span>üé≤</span>';
    randomBtn.onclick = loadRandomTask;
    grid.appendChild(randomBtn);
}

// Aufgabe laden
function loadTask(taskId) {
    currentTask = taskId;
    
    // Task-Data holen (Random oder Original)
    if (isRandomMode && GENERATOR.supportsRandom(taskId)) {
        currentTaskData = GENERATOR.generate(taskId);
        document.getElementById('randomBadge').style.display = 'inline-flex';
    } else {
        currentTaskData = GENERATOR.getOriginal(taskId);
        document.getElementById('randomBadge').style.display = 'none';
    }
    
    if (!currentTaskData) return;
    
    // Buttons aktualisieren
    document.querySelectorAll('.task-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('task' + taskId)?.classList.add('active');
    
    // Info anzeigen
    document.getElementById('infoCard').classList.add('show');
    document.getElementById('infoTitle').textContent = 'Aufgabe ' + taskId + ': ' + currentTaskData.name;
    document.getElementById('infoText').textContent = currentTaskData.text;
    document.getElementById('infoBadge').textContent = currentTaskData.badge;
    
    // Result verstecken
    document.getElementById('resultCard').classList.remove('show');
    
    // Session Info
    document.getElementById('sessionInfo').textContent = 
        session.correct.length + ' richtig, ' + session.wrong.length + ' falsch';
    
    // Felder f√ºllen
    resetFields();
    
    if (currentTaskData.data) {
        const d = currentTaskData.data;
        document.getElementById('mek').value = d.mek || '';
        document.getElementById('porto').value = d.porto || 0;
        document.getElementById('mgk').value = d.mgk || 35.4;
        document.getElementById('min1').value = d.min1 || 0;
        document.getElementById('rate1').value = d.rate1 || 58.90;
        document.getElementById('min2').value = d.min2 || 0;
        document.getElementById('rate2').value = d.rate2 || 60.50;
        document.getElementById('pausch').value = d.pausch || 0;
        document.getElementById('gewinn').value = d.gewinn || '';
        
        document.getElementById('fert2Row').style.display = currentTaskData.showFert2 ? 'block' : 'none';
    }
    
    calculate();
    document.getElementById('infoCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Zuf√§llige Aufgabe
function loadRandomTask() {
    const stats = PROFILES.getStats();
    const unsolved = GENERATOR.getAllTaskIds().filter(id => !stats.solvedTasks.includes(id));
    const pool = unsolved.length > 0 ? unsolved : GENERATOR.getAllTaskIds();
    const randomId = pool[Math.floor(Math.random() * pool.length)];
    loadTask(randomId);
}

// Neue Zufallszahlen f√ºr aktuelle Aufgabe
function regenerateTask() {
    if (currentTask && GENERATOR.supportsRandom(currentTask)) {
        isRandomMode = true;
        document.getElementById('randomMode').checked = true;
        document.getElementById('modeBadge').textContent = 'Zufall';
        loadTask(currentTask);
    }
}

// Random-Modus umschalten
function toggleRandomMode() {
    isRandomMode = document.getElementById('randomMode').checked;
    document.getElementById('modeBadge').textContent = isRandomMode ? 'Zufall' : 'Original';
    
    if (currentTask) {
        loadTask(currentTask);
    }
}

// Berechnung
function calculate() {
    const values = {
        mek: parseFloat(document.getElementById('mek').value) || 0,
        porto: parseFloat(document.getElementById('porto').value) || 0,
        mgk: parseFloat(document.getElementById('mgk').value) || 0,
        min1: parseFloat(document.getElementById('min1').value) || 0,
        rate1: parseFloat(document.getElementById('rate1').value) || 0,
        min2: parseFloat(document.getElementById('min2').value) || 0,
        rate2: parseFloat(document.getElementById('rate2').value) || 0,
        pausch: parseFloat(document.getElementById('pausch').value) || 0,
        gewinn: parseFloat(document.getElementById('gewinn').value) || 0
    };
    
    const result = GENERATOR.calculate(values);
    
    document.getElementById('resMek').textContent = eur(result.mekTotal);
    document.getElementById('resMgk').textContent = eur(result.mgkVal);
    document.getElementById('resMges').textContent = eur(result.mges);
    document.getElementById('resFert1').textContent = eur(result.fert1);
    document.getElementById('resFert2').textContent = eur(result.fert2);
    document.getElementById('resSk').textContent = eur(result.sk);
    document.getElementById('resGewinn').textContent = eur(result.gewinnVal);
    document.getElementById('resNvp').textContent = eur(result.nvp);
    document.getElementById('resMwst').textContent = eur(result.mwst);
    document.getElementById('resBvp').textContent = eur(result.bvp);
    
    return result.bvp;
}

// Ergebnis pr√ºfen
function checkResult() {
    if (!currentTask || !currentTaskData) {
        alert('Bitte w√§hle zuerst eine Aufgabe!');
        return;
    }
    
    const resultCard = document.getElementById('resultCard');
    
    // R√ºckrechnungen
    if (currentTaskData.type === 'reverse') {
        resultCard.className = 'result-card show info';
        document.getElementById('resultIcon').textContent = 'üìù';
        document.getElementById('resultTitle').textContent = 'Musterl√∂sung';
        document.getElementById('resultText').textContent = 'Diese Aufgabe ist eine R√ºckrechnung.';
        document.getElementById('resultValues').innerHTML = 
            '<div style="text-align: center;"><div class="text-muted" style="font-size: 0.8rem;">L√∂sung</div><div style="font-size: 1.2rem; font-weight: 700; color: var(--accent);">' + currentTaskData.solution + '</div></div>';
        
        if (!session.attempted.includes(currentTask)) {
            session.attempted.push(currentTask);
            session.correct.push(currentTask);
        }
        
        updateSessionInfo();
        resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    // Vorw√§rtskalkulation
    const myResult = calculate();
    const target = currentTaskData.solution;
    const diff = Math.abs(myResult - target);
    const isCorrect = diff < 0.03;
    
    resultCard.className = 'result-card show ' + (isCorrect ? 'success' : 'error');
    document.getElementById('resultIcon').textContent = isCorrect ? '‚úÖ' : '‚ùå';
    document.getElementById('resultTitle').textContent = isCorrect ? 'Richtig!' : 'Nicht ganz richtig';
    document.getElementById('resultText').textContent = isCorrect ? 
        'Super gemacht! Weiter so!' : 
        'Differenz: ' + eur(diff) + ' ‚Äì Pr√ºfe deine Eingaben.';
    
    document.getElementById('resultValues').innerHTML = 
        '<div style="text-align: center;"><div class="text-muted" style="font-size: 0.8rem;">Dein Ergebnis</div><div style="font-size: 1.2rem; font-weight: 700; color: var(--accent);">' + eur(myResult) + '</div></div>' +
        '<div style="text-align: center;"><div class="text-muted" style="font-size: 0.8rem;">L√∂sung</div><div style="font-size: 1.2rem; font-weight: 700; color: var(--success);">' + eur(target) + '</div></div>';
    
    // Session + Profil aktualisieren
    if (!session.attempted.includes(currentTask)) {
        session.attempted.push(currentTask);
    }
    
    if (isCorrect) {
        if (!session.correct.includes(currentTask)) {
            session.correct.push(currentTask);
        }
        PROFILES.markSolved(currentTask);
        document.getElementById('task' + currentTask)?.classList.add('solved');
    } else {
        if (!session.wrong.includes(currentTask) && !session.correct.includes(currentTask)) {
            session.wrong.push(currentTask);
        }
        PROFILES.markWrong();
    }
    
    updateSessionInfo();
    resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Session-Info aktualisieren
function updateSessionInfo() {
    document.getElementById('sessionInfo').textContent = 
        session.correct.length + ' richtig, ' + session.wrong.length + ' falsch';
}

// Session beenden
function endSession() {
    PROFILES.addSession({
        attempted: session.attempted.length,
        correct: session.correct.length,
        wrong: session.wrong.length
    });
    
    sessionStorage.setItem('lastSession', JSON.stringify(session));
}

// Felder zur√ºcksetzen
function resetFields() {
    document.getElementById('mek').value = '';
    document.getElementById('porto').value = 0;
    document.getElementById('mgk').value = 35.4;
    document.getElementById('min1').value = 0;
    document.getElementById('rate1').value = 58.90;
    document.getElementById('min2').value = 0;
    document.getElementById('rate2').value = 60.50;
    document.getElementById('pausch').value = 0;
    document.getElementById('gewinn').value = '';
    document.getElementById('fert2Row').style.display = 'none';
}

function resetCalc() {
    resetFields();
    document.getElementById('infoCard').classList.remove('show');
    document.getElementById('resultCard').classList.remove('show');
    currentTask = null;
    currentTaskData = null;
    document.querySelectorAll('.task-btn').forEach(btn => btn.classList.remove('active'));
    calculate();
}

// Hilfe-Modal
function showHelp(key) {
    const help = HELP[key];
    if (!help) return;
    
    let content = '<p style="margin-bottom: 16px;">' + help.text + '</p>';
    content += '<ul style="list-style: none;">';
    help.details.forEach(d => {
        content += '<li style="padding: 8px 0; border-bottom: 1px solid var(--glass-border);">‚Ä¢ ' + d + '</li>';
    });
    content += '</ul>';
    
    document.getElementById('modalTitle').innerHTML = '‚ÑπÔ∏è ' + help.title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modalOverlay').classList.add('show');
}

function showTaskHelp() {
    if (!currentTaskData || !currentTaskData.help) return;
    
    const h = currentTaskData.help;
    let content = '<p><strong>Gegeben:</strong> ' + h.gegeben + '</p>';
    content += '<p><strong>Gesucht:</strong> ' + h.gesucht + '</p>';
    content += '<p style="margin: 16px 0;"><strong>L√∂sungsweg:</strong></p>';
    content += '<div style="background: var(--glass-bg); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; color: var(--accent); white-space: pre-wrap;">' + h.formel + '</div>';
    content += '<p style="margin-top: 16px;"><strong>üí° Tipp:</strong> ' + h.tipp + '</p>';
    content += '<p><strong>MGK-Satz:</strong> ' + h.mgkTyp + '</p>';
    
    document.getElementById('modalTitle').innerHTML = 'üìù Hilfe: Aufgabe ' + currentTask;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

// Event Listeners
document.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', calculate);
    input.addEventListener('change', calculate);
});

document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
});

// URL-Parameter
const params = new URLSearchParams(window.location.search);
if (params.get('mode') === 'random') {
    isRandomMode = true;
    document.getElementById('randomMode').checked = true;
    document.getElementById('modeBadge').textContent = 'Zufall';
}

// Init
initTaskGrid();
calculate();

// Auto-Load from URL
if (params.get('task')) {
    loadTask(parseInt(params.get('task')));
} else if (params.get('random') === '1') {
    loadRandomTask();
}

}); // Ende STORAGE.onReady
</script>

</body>
</html>
