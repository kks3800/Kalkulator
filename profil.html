<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil | Kalkulations-Trainer</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Profile Header -->
    <div class="card text-center" style="padding: 30px 20px;">
        <div id="profileAvatar" style="width: 80px; height: 80px; margin: 0 auto 16px; background: linear-gradient(135deg, var(--accent), var(--success)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
            üë§
        </div>
        <h1 id="profileName" style="font-size: 1.5rem; margin-bottom: 4px;">Name</h1>
        <p class="text-muted" id="profileDate">Dabei seit ...</p>
    </div>

    <!-- Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Statistiken</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="statSolved">0</div>
                <div class="stat-label">Gel√∂st</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statAccuracy">0%</div>
                <div class="stat-label">Genauigkeit</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statStreak">0</div>
                <div class="stat-label">Beste Serie</div>
            </div>
        </div>

        <div class="progress-bar mt-2">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <p class="text-center text-muted mt-1" id="progressText">0 von 11 Aufgaben gemeistert</p>
    </div>

    <!-- Detailed Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Details</span>
        </div>
        
        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--glass-border);">
                <span class="text-muted">Gesamt richtig</span>
                <span class="text-accent" id="detailCorrect">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--glass-border);">
                <span class="text-muted">Gesamt Versuche</span>
                <span id="detailAttempts">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--glass-border);">
                <span class="text-muted">Sessions</span>
                <span id="detailSessions">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                <span class="text-muted">Aktuelle Serie</span>
                <span class="text-warning" id="detailCurrentStreak">0 üî•</span>
            </div>
        </div>
    </div>

    <!-- Solved Tasks -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Gemeisterte Aufgaben</span>
        </div>
        
        <div class="task-grid" id="solvedGrid" style="margin-bottom: 8px;"></div>
        <p class="text-center text-muted" style="font-size: 0.8rem;" id="solvedInfo">
            Gr√ºne Aufgaben wurden gel√∂st
        </p>
    </div>

    <!-- Actions -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Aktionen</span>
        </div>
        
        <button type="button" class="btn btn-secondary btn-block mb-2" id="btnSwitchProfile">
            üîÑ Profil wechseln
        </button>
        
        <button type="button" class="btn btn-secondary btn-block mb-2" id="btnResetProgress">
            üìä Fortschritt zur√ºcksetzen
        </button>
        
        <button type="button" class="btn btn-danger btn-block" id="btnDeleteProfile">
            üóëÔ∏è Profil l√∂schen
        </button>
    </div>

    <!-- App Info -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">‚ÑπÔ∏è √úber die App</span>
        </div>
        <p class="text-muted" style="font-size: 0.85rem; line-height: 1.6;">
            Kalkulations-Trainer f√ºr H√∂rakustik<br>
            Lernfeld 17.2 ‚Äì Preiskalkulation<br><br>
            Version 2.0 ¬∑ Made with ‚ù§Ô∏è
        </p>
    </div>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="./home.html" class="nav-item">
        <span class="icon">üè†</span>
        <span>Home</span>
    </a>
    <a href="./trainer.html" class="nav-item">
        <span class="icon">üìä</span>
        <span>√úben</span>
    </a>
    <a href="./profil.html" class="nav-item active">
        <span class="icon">üë§</span>
        <span>Profil</span>
    </a>
</nav>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Best√§tigen</h3>
            <button type="button" class="modal-close" id="modalCloseBtn">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- Scripts -->
<script src="./js/storage.js?v=5"></script>
<script src="./js/profanity.js?v=5"></script>
<script src="./js/profiles.js?v=5"></script>
<script src="./js/generator.js?v=5"></script>
<script>
// Global stats variable
let stats = null;

// Modal functions (global)
function showModal(title, body, footer) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalFooter').innerHTML = footer;
    document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

// Action functions (global)
function switchProfile() {
    showModal(
        'üîÑ Profil wechseln',
        '<p class="text-muted">Du wirst ausgeloggt und kannst ein anderes Profil w√§hlen oder ein neues erstellen.</p>',
        '<div style="display: flex; gap: 12px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" style="flex:1;" onclick="doSwitchProfile()">Wechseln</button></div>'
    );
}

async function doSwitchProfile() {
    await PROFILES.logout();
    window.location.href = './index.html';
}

function resetProgress() {
    showModal(
        'üìä Fortschritt zur√ºcksetzen',
        '<p class="text-muted">Alle gel√∂sten Aufgaben und Statistiken werden zur√ºckgesetzt. Dein Profil bleibt erhalten.</p><p style="color: var(--warning); margin-top: 12px;">‚ö†Ô∏è Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>',
        '<div style="display: flex; gap: 12px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-warning" style="flex:1; background: var(--warning); color: var(--bg-dark);" onclick="doResetProgress()">Zur√ºcksetzen</button></div>'
    );
}

async function doResetProgress() {
    await PROFILES.update({
        solvedTasks: [],
        totalCorrect: 0,
        totalAttempts: 0,
        bestStreak: 0,
        currentStreak: 0,
        sessions: []
    });
    window.location.reload();
}

function deleteProfile() {
    if (!stats) return;
    showModal(
        'üóëÔ∏è Profil l√∂schen',
        '<p class="text-muted">Dein Profil <strong>"' + stats.name + '"</strong> wird vollst√§ndig gel√∂scht.</p><p style="color: var(--danger); margin-top: 12px;">‚ö†Ô∏è Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>',
        '<div style="display: flex; gap: 12px;"><button class="btn btn-secondary" style="flex:1;" onclick="closeModal()">Abbrechen</button><button class="btn btn-danger" style="flex:1;" onclick="doDeleteProfile()">L√∂schen</button></div>'
    );
}

async function doDeleteProfile() {
    if (!stats) return;
    await PROFILES.remove(stats.name);
    window.location.href = './index.html';
}

// Event Listeners
document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
});
document.getElementById('btnSwitchProfile').addEventListener('click', switchProfile);
document.getElementById('btnResetProgress').addEventListener('click', resetProgress);
document.getElementById('btnDeleteProfile').addEventListener('click', deleteProfile);

// Initialize
STORAGE.onReady(async () => {
    await PROFILES.init();
    
    // Profil pr√ºfen
    const profile = PROFILES.getCurrent();
    if (!profile) {
        window.location.href = './index.html';
        return;
    }
    
    stats = PROFILES.getStats();
    
    // Avatar
    const avatars = ['üë§', 'üéì', 'üìö', 'üí™', 'üéØ', '‚≠ê', 'üèÜ', 'üöÄ'];
    document.getElementById('profileAvatar').textContent = avatars[stats.name.length % avatars.length];
    
    // Profilinfo
    document.getElementById('profileName').textContent = stats.name;
    
    const created = new Date(profile.data.created);
    const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('profileDate').textContent = 'Dabei seit ' + months[created.getMonth()] + ' ' + created.getFullYear();
    
    // Statistiken
    document.getElementById('statSolved').textContent = stats.solved;
    document.getElementById('statAccuracy').textContent = stats.accuracy + '%';
    document.getElementById('statStreak').textContent = stats.bestStreak;
    
    document.getElementById('detailCorrect').textContent = stats.totalCorrect;
    document.getElementById('detailAttempts').textContent = stats.totalAttempts;
    document.getElementById('detailSessions').textContent = stats.sessionsCount;
    document.getElementById('detailCurrentStreak').textContent = stats.currentStreak + ' üî•';
    
    // Progress
    const progress = Math.round((stats.solved / 11) * 100);
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = stats.solved + ' von 11 Aufgaben gemeistert';
    
    // Solved Grid
    const solvedGrid = document.getElementById('solvedGrid');
    GENERATOR.getAllTaskIds().forEach(id => {
        const div = document.createElement('div');
        div.className = 'task-btn';
        div.style.cursor = 'default';
        div.innerHTML = '<span>' + id + '</span>';
        
        if (stats.solvedTasks.includes(id)) {
            div.classList.add('solved');
        }
        
        solvedGrid.appendChild(div);
    });
    
    document.getElementById('solvedInfo').textContent = stats.solved + ' von 11 Aufgaben gemeistert';
});
</script>

</body>
</html>
