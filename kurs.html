<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kurs | Kalkulations-Trainer</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* Kurs-spezifische Styles */
        .chapter-header {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .chapter-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chapter-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: 4px;
            font-weight: 600;
        }
        .chapter-badge.theory { background: #8b5cf6; color: white; }
        .chapter-badge.exercise { background: var(--accent); }
        .chapter-badge.quiz { background: var(--warning); color: var(--bg-dark); }
        .chapter-badge.result { background: var(--success); color: white; }
        
        .progress-compact {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .progress-bar-mini {
            flex: 1;
            height: 8px;
            background: var(--glass-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-mini .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .content-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }
        .content-card h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        .content-card p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 12px;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .info-table td {
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
        }
        .info-table td:first-child {
            color: var(--text-muted);
        }
        .info-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: var(--accent);
        }
        .info-table tr:last-child td {
            border-bottom: none;
        }
        
        .formula-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 16px;
            font-family: monospace;
            font-size: 0.95rem;
            color: var(--accent);
            line-height: 1.8;
            margin: 16px 0;
        }
        
        .example-box {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.1), rgba(0, 204, 136, 0.05));
            border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin: 16px 0;
        }
        .example-box h4 {
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-text {
            background: var(--glass-bg);
            border-left: 4px solid var(--accent);
            padding: 16px;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 20px;
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .calc-section {
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin: 16px 0;
        }
        .calc-section h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .calc-row-simple {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .calc-row-simple label {
            flex: 1;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .calc-row-simple input {
            width: 100px;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            text-align: right;
        }
        .calc-row-simple input:focus {
            border-color: var(--accent);
            outline: none;
        }
        .calc-row-simple .unit {
            color: var(--text-muted);
            width: 30px;
        }
        .calc-row-simple.readonly input {
            background: transparent;
            border-color: transparent;
            color: var(--accent);
            font-weight: 600;
        }
        .calc-result-box {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.15), rgba(0, 204, 136, 0.1));
            border: 2px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            margin-top: 16px;
        }
        .calc-result-box .label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .calc-result-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        /* Quiz Styles */
        .quiz-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-option:hover {
            border-color: var(--accent);
        }
        .quiz-option.selected {
            border-color: var(--accent);
            background: rgba(0, 245, 212, 0.1);
        }
        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.2);
        }
        .quiz-option.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.2);
        }
        .quiz-option .radio {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-option.selected .radio {
            border-color: var(--accent);
            background: var(--accent);
        }
        .quiz-option.selected .radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 50%;
        }
        
        /* Drag & Drop */
        .drag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            min-height: 60px;
            margin-bottom: 12px;
        }
        .drag-item {
            padding: 10px 16px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: grab;
            user-select: none;
            touch-action: none;
        }
        .drag-item:active {
            cursor: grabbing;
        }
        .drop-zone {
            display: flex;
            gap: 8px;
            padding: 16px;
            background: var(--bg-dark);
            border: 2px dashed var(--glass-border);
            border-radius: var(--radius-sm);
            min-height: 60px;
            flex-wrap: wrap;
        }
        .drop-zone.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.1);
        }
        .drop-zone.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.1);
        }
        
        /* Fill in the blank */
        .fill-blank {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .fill-blank input {
            width: 80px;
            padding: 8px;
            background: var(--bg-dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            font-weight: 600;
        }
        .fill-blank input:focus {
            border-color: var(--accent);
            outline: none;
        }
        .fill-blank input.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.2);
        }
        .fill-blank input.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.2);
        }
        
        /* Navigation */
        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .nav-buttons.single {
            grid-template-columns: 1fr;
        }
        
        /* Results */
        .result-hero {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(0, 204, 136, 0.2), rgba(0, 245, 212, 0.1));
            border: 2px solid var(--success);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        .result-hero .icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
        .result-hero h2 {
            color: var(--success);
            margin-bottom: 8px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        .stat-item {
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }
        .stat-item .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-item .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Hint button */
        .hint-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 245, 212, 0.3);
        }
        .hint-btn:hover, .hint-btn:active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-dark);
        }
        
        .hint-box {
            display: none;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.1));
            border: 1px solid #8b5cf6;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-top: 12px;
        }
        .hint-box.show {
            display: block;
        }
        .hint-box h4 {
            color: #a78bfa;
            margin-bottom: 8px;
        }
        
        /* Floating Help Button */
        .floating-help-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .floating-help-btn:hover,
        .floating-help-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        /* Skip button style */
        .btn-skip {
            background: transparent !important;
            border-color: var(--text-muted) !important;
            color: var(--text-muted) !important;
            font-size: 0.85rem;
        }
        .btn-skip:hover {
            border-color: var(--accent) !important;
            color: var(--accent) !important;
        }
    </style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Chapter Header with Progress -->
    <div class="chapter-header">
        <div class="chapter-title">
            <span id="chapterTitle">Kapitel 1: Einf√ºhrung</span>
            <span class="chapter-badge theory" id="chapterBadge">Theorie</span>
        </div>
        <div class="progress-compact">
            <div class="progress-bar-mini">
                <div class="fill" id="progressFill" style="width: 0%"></div>
            </div>
            <span class="progress-text" id="progressText">1 / 12</span>
        </div>
    </div>

    <!-- Content Area (filled by JS) -->
    <div id="contentArea">
        <!-- Dynamic content -->
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons" id="navButtons" style="grid-template-columns: 1fr 1fr 1fr;">
        <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
            ‚Üê Zur√ºck
        </button>
        <button type="button" class="btn btn-secondary" id="skipBtn" style="background: transparent; border-color: var(--text-muted); color: var(--text-muted);">
            √úberspringen
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
            Weiter ‚Üí
        </button>
    </div>
    
    <!-- Help Button (floating) -->
    <button type="button" class="floating-help-btn" id="floatingHelpBtn" onclick="showChapterHelp()">
        ?
    </button>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="./kurs.html" class="nav-item active">
        <svg class="icon" viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"></path></svg>
        <span>Kurs</span>
    </a>
    <a href="./profil.html" class="nav-item">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Profil</span>
    </a>
</nav>

<!-- Hint Modal -->
<div class="modal-overlay" id="hintModal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="hintTitle">üí° Tipp</h3>
            <button type="button" class="modal-close" onclick="closeHint()">√ó</button>
        </div>
        <div class="modal-body" id="hintBody"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-block" onclick="closeHint()">Verstanden</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="./js/storage.js?v=7"></script>
<script src="./js/profanity.js?v=7"></script>
<script src="./js/profiles.js?v=7"></script>
<script src="./js/generator.js?v=7"></script>
<script>
// ===== KURS DATEN =====
const CHAPTERS = [
    // Kapitel 1: Einf√ºhrung
    {
        id: 1,
        title: "Einf√ºhrung",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>Was ist Kalkulation?</h2>
                <p>
                    Die <strong>Kalkulation</strong> ist die Berechnung des Verkaufspreises f√ºr ein Produkt oder eine Dienstleistung.
                </p>
                <p>
                    Du startest beim <strong>Einkaufspreis</strong> und rechnest Schritt f√ºr Schritt alle Kosten und Zuschl√§ge dazu, bis du beim <strong>Bruttoverkaufspreis (BVP)</strong> landest.
                </p>
                
                <div class="example-box">
                    <h4>üìã Das Kalkulationsschema</h4>
                    <div class="formula-box">
Listenpreis / Einkauf<br>
+ Bezugskosten (Porto)<br>
<strong style="color: var(--accent);">= MEK (Materialeinzelkosten)</strong><br>
+ MGK (Materialgemeinkosten)<br>
<strong style="color: var(--accent);">= Mges (Materialgesamtkosten)</strong><br>
+ Fertigungskosten<br>
<strong style="color: var(--success);">= Sk (Selbstkosten)</strong><br>
+ Gewinn<br>
<strong style="color: var(--success);">= NVP (Nettoverkaufspreis)</strong><br>
+ MwSt (19%)<br>
<strong style="color: var(--warning);">= BVP (Bruttoverkaufspreis)</strong>
                    </div>
                </div>
            </div>
        `
    },
    
    // Kapitel 2: Die Zuschl√§ge
    {
        id: 2,
        title: "Die Zuschl√§ge",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>MGK-Zuschlagss√§tze</h2>
                <p>
                    Die <strong>Materialgemeinkosten (MGK)</strong> decken Kosten ab, die nicht direkt einem Produkt zugeordnet werden k√∂nnen (z.B. Lager, Verwaltung).
                </p>
                <p>
                    Je nach Produktart gibt es unterschiedliche Zuschlagss√§tze:
                </p>
                
                <table class="info-table">
                    <tr>
                        <td>üîä H√∂rger√§te</td>
                        <td style="color: var(--accent);">32,8 %</td>
                    </tr>
                    <tr>
                        <td>üëÇ Otoplastik / Material</td>
                        <td style="color: var(--success);">35,4 %</td>
                    </tr>
                    <tr>
                        <td>‚è∞ Handelswaren (Wecker, Batterien)</td>
                        <td style="color: var(--warning);">108 %</td>
                    </tr>
                </table>
                
                <div class="example-box">
                    <h4>‚ö†Ô∏è Wichtig zu merken</h4>
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong>Handelswaren</strong> wie Wecksysteme, Batterien, Pflegeprodukte haben den h√∂chsten MGK-Satz von <strong style="color: var(--warning);">108%</strong>!
                    </p>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Fertigungsstundens√§tze</h2>
                <p>Die Fertigungskosten werden nach Arbeitszeit berechnet:</p>
                
                <table class="info-table">
                    <tr>
                        <td>HG-Anpassung</td>
                        <td>60,50 ‚Ç¨/h</td>
                    </tr>
                    <tr>
                        <td>Audiometrie</td>
                        <td>63,40 ‚Ç¨/h</td>
                    </tr>
                    <tr>
                        <td>Werkstatt / Labor</td>
                        <td>58,90 ‚Ç¨/h</td>
                    </tr>
                </table>
                
                <div class="formula-box">
                    <strong>Formel:</strong><br>
                    Fertigungskosten = (Minuten √∑ 60) √ó Stundensatz
                </div>
            </div>
        `
    },
    
    // Kapitel 3: Erste Rechnung (Beispiel)
    {
        id: 3,
        title: "Erste Rechnung",
        type: "example",
        badge: "Beispiel",
        content: `
            <div class="content-card">
                <h2>Schritt-f√ºr-Schritt Beispiel</h2>
                
                <div class="task-text">
                    <strong>Aufgabe:</strong> Ein Ersatzteil kostet <strong>65,50 ‚Ç¨</strong>. 
                    Die Reparatur dauert <strong>35 Minuten</strong> in der Werkstatt. 
                    Der Gewinnzuschlag betr√§gt <strong>9%</strong>.
                    Berechne den Bruttoverkaufspreis.
                </div>
                
                <div class="calc-section">
                    <h4>üìä L√∂sung:</h4>
                    
                    <div class="formula-box">
<strong>1. MEK ermitteln:</strong><br>
   MEK = 65,50 ‚Ç¨ (Ersatzteil, kein Porto)<br><br>

<strong>2. MGK berechnen:</strong><br>
   MGK-Satz f√ºr Material = 35,4%<br>
   MGK = 65,50 √ó 0,354 = 23,19 ‚Ç¨<br><br>

<strong>3. Mges = MEK + MGK:</strong><br>
   Mges = 65,50 + 23,19 = 88,69 ‚Ç¨<br><br>

<strong>4. Fertigungskosten:</strong><br>
   Fert = (35 √∑ 60) √ó 58,90 = 34,36 ‚Ç¨<br><br>

<strong>5. Selbstkosten:</strong><br>
   Sk = 88,69 + 34,36 = 123,05 ‚Ç¨<br><br>

<strong>6. Gewinn addieren (9%):</strong><br>
   NVP = 123,05 √ó 1,09 = 134,12 ‚Ç¨<br><br>

<strong>7. MwSt addieren (19%):</strong><br>
   BVP = 134,12 √ó 1,19 = <span style="color: var(--success); font-size: 1.2em;">159,60 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        `
    },
    
    // Kapitel 4: Erste eigene √úbung
    {
        id: 4,
        title: "Selber rechnen",
        type: "exercise",
        badge: "√úbung",
        taskId: 3,
        taskText: "Ein Kunde bringt ein H√∂rger√§t zur Reparatur. Das Ersatzteil kostet <strong>65,50 ‚Ç¨</strong>. Die Reparatur dauert <strong>35 Minuten</strong> in der Werkstatt. Der Gewinnzuschlag betr√§gt <strong>9%</strong>. Au√üerdem wird eine Pauschale von <strong>6,95 ‚Ç¨</strong> berechnet.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MGK-Satz: 35,4% (Material/Reparatur)", "Stundensatz Werkstatt: 58,90 ‚Ç¨/h", "Pauschale zu Selbstkosten addieren!"],
        solution: { mek: 65.50, mgk: 35.4, min1: 35, rate1: 58.90, pausch: 6.95, gewinn: 9 }
    },
    
    // Kapitel 5: Handelswaren Theorie
    {
        id: 5,
        title: "Handelswaren",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>Handelswaren: 108% MGK</h2>
                <p>
                    <strong>Handelswaren</strong> sind Produkte, die der Akustiker nicht selbst herstellt, sondern nur weiterverkauft.
                </p>
                
                <div class="example-box">
                    <h4>üì¶ Beispiele f√ºr Handelswaren</h4>
                    <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px;">
                        <li>Wecksysteme / Lichtwecker</li>
                        <li>Batterien</li>
                        <li>Pflegeprodukte</li>
                        <li>Zubeh√∂r</li>
                    </ul>
                </div>
                
                <p>
                    Der hohe MGK-Satz von <strong style="color: var(--warning);">108%</strong> ber√ºcksichtigt, dass der H√§ndler diese Produkte nur im Sortiment hat und keinen gro√üen Fertigungsaufwand hat.
                </p>
                
                <div class="formula-box">
                    <strong>Beispiel Wecksystem:</strong><br>
                    MEK = 45,00 ‚Ç¨<br>
                    MGK = 45,00 √ó 1,08 = 48,60 ‚Ç¨<br>
                    Mges = 45,00 + 48,60 = <strong>93,60 ‚Ç¨</strong>
                </div>
            </div>
        `
    },
    
    // Kapitel 6: Wecksystem √úbung
    {
        id: 6,
        title: "Wecksystem",
        type: "exercise",
        badge: "√úbung",
        taskId: 4,
        taskText: "Ein Kunde m√∂chte ein Wecksystem kaufen. Der Einkaufspreis betr√§gt <strong>55,00 ‚Ç¨</strong>. Beratungszeit: <strong>30 Minuten</strong> (HG-Anpassung). Gewinnzuschlag: <strong>12%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["‚ö†Ô∏è Wecksystem = Handelsware = 108% MGK!", "Stundensatz HG-Anpassung: 60,50 ‚Ç¨/h"],
        solution: { mek: 55.00, mgk: 108, min1: 30, rate1: 60.50, pausch: 0, gewinn: 12 }
    },
    
    // Kapitel 7: Otoplastik (Porto-Trick)
    {
        id: 7,
        title: "Otoplastik",
        type: "exercise",
        badge: "√úbung",
        taskId: 9,
        taskText: "F√ºr einen Kunden wird eine Otoplastik angefertigt. Materialkosten: <strong>12,80 ‚Ç¨</strong>. Transportkosten: <strong>3,50 ‚Ç¨</strong>. Arbeitszeit Labor: <strong>25 Minuten</strong>. Gewinnzuschlag: <strong>8%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["‚ö†Ô∏è WICHTIG: Transportkosten ZUERST zu MEK addieren!", "MGK-Satz Otoplastik: 35,4%", "Dann MGK auf die SUMME berechnen!"],
        solution: { mek: 12.80, porto: 3.50, mgk: 35.4, min1: 25, rate1: 58.90, pausch: 0, gewinn: 8 }
    },
    
    // Kapitel 8: Quiz
    {
        id: 8,
        title: "Quiz-Time",
        type: "quiz",
        badge: "Quiz",
        questions: [
            {
                q: "Welcher MGK-Satz gilt f√ºr ein Wecksystem?",
                options: ["32,8%", "35,4%", "108%"],
                correct: 2
            },
            {
                q: "Was ist der Stundensatz f√ºr Werkstatt-Arbeiten?",
                options: ["58,90 ‚Ç¨/h", "60,50 ‚Ç¨/h", "63,40 ‚Ç¨/h"],
                correct: 0
            },
            {
                q: "Wann werden Transportkosten addiert?",
                options: ["Nach der MGK-Berechnung", "VOR der MGK-Berechnung zum MEK", "Zum Nettoverkaufspreis"],
                correct: 1
            },
            {
                q: "Wie berechnet man den BVP aus dem NVP?",
                options: ["NVP √ó 0,19", "NVP + 19", "NVP √ó 1,19"],
                correct: 2
            }
        ]
    },
    
    // Kapitel 8b: Sortier-Spiel
    {
        id: '8b',
        title: "Reihenfolge",
        type: "sorting",
        badge: "Spiel",
        instruction: "Bringe die Kalkulationsschritte in die richtige Reihenfolge:",
        items: ["BVP", "Selbstkosten", "MEK", "NVP", "Mges"],
        correctOrder: ["MEK", "Mges", "Selbstkosten", "NVP", "BVP"]
    },
    
    // Kapitel 8c: L√ºckentext
    {
        id: '8c',
        title: "Formeln",
        type: "fillblank",
        badge: "Spiel",
        instruction: "Vervollst√§ndige die Formeln:",
        blanks: [
            { text: "Fertigungskosten = Minuten √∑ ___ √ó Stundensatz", answer: "60", hint: "Minuten in Stunden umrechnen" },
            { text: "BVP = NVP √ó ___", answer: "1,19", hint: "MwSt-Faktor" },
            { text: "MGK Handelswaren = ___ %", answer: "108", hint: "Der h√∂chste Satz" }
        ]
    },
    
    // Kapitel 9: Paar H√∂rger√§te
    {
        id: 9,
        title: "Paar H√∂rger√§te",
        type: "exercise",
        badge: "√úbung",
        taskId: 6,
        taskText: "Ein Kunde kauft ein Paar H√∂rger√§te. Listenpreis f√ºr beide: <strong>1.890,00 ‚Ç¨</strong>. Anpasszeit: <strong>90 Minuten</strong> (HG-Anpassung). Audiometrie: <strong>45 Minuten</strong>. Gewinnzuschlag: <strong>15%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MGK-Satz H√∂rger√§te: 32,8%", "Zwei verschiedene Stundens√§tze!", "HG-Anpassung: 60,50 ‚Ç¨/h", "Audiometrie: 63,40 ‚Ç¨/h"],
        solution: { mek: 1890.00, mgk: 32.8, min1: 90, rate1: 60.50, min2: 45, rate2: 63.40, pausch: 0, gewinn: 15 },
        showFert2: true
    },
    
    // Kapitel 10: R√ºckrechnung
    {
        id: 10,
        title: "R√ºckrechnung",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>R√ºckw√§rts rechnen</h2>
                <p>
                    Manchmal musst du vom <strong>BVP</strong> zur√ºck zum <strong>MEK</strong> rechnen. Dabei werden alle Schritte <em>umgekehrt</em>.
                </p>
                
                <div class="formula-box">
<strong>R√ºckrechnung:</strong><br><br>
BVP (gegeben)<br>
√∑ 1,19 = NVP<br>
√∑ (1 + Gewinn%) = Sk<br>
- Fertigungskosten = Mges<br>
√∑ (1 + MGK%) = MEK
                </div>
                
                <div class="example-box">
                    <h4>üìù Beispiel</h4>
                    <p style="color: var(--text-secondary); margin: 0;">
                        BVP = 200,00 ‚Ç¨<br>
                        NVP = 200 √∑ 1,19 = 168,07 ‚Ç¨<br>
                        Bei 10% Gewinn: Sk = 168,07 √∑ 1,10 = 152,79 ‚Ç¨
                    </p>
                </div>
            </div>
        `
    },
    
    // Kapitel 11: Abschlusstest
    {
        id: 11,
        title: "Abschlusstest",
        type: "exercise",
        badge: "Pr√ºfung",
        taskId: 11,
        taskText: "F√ºr einen Kunden wird ein individueller Geh√∂rschutz angefertigt. Materialmenge: <strong>15,60 ‚Ç¨</strong>. Dazu 2 Filter √† <strong>4,20 ‚Ç¨</strong>. Arbeitszeit Labor: <strong>40 Minuten</strong>. Gewinnzuschlag: <strong>10%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MEK = Material + 2 √ó Filter", "MGK-Satz Material: 35,4%", "Stundensatz Werkstatt: 58,90 ‚Ç¨/h"],
        solution: { mek: 24.00, mgk: 35.4, min1: 40, rate1: 58.90, pausch: 0, gewinn: 10 }
    },
    
    // Kapitel 12: Ergebnis
    {
        id: 12,
        title: "Ergebnis",
        type: "result",
        badge: "Abschluss"
    }
];

// ===== STATE =====
let currentChapter = 0;
let quizAnswers = [];
let exerciseResults = [];
let sessionStats = { correct: 0, wrong: 0, total: 0 };

// ===== FUNCTIONS =====

function updateProgress() {
    const progress = Math.round(((currentChapter + 1) / CHAPTERS.length) * 100);
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${currentChapter + 1} / ${CHAPTERS.length}`;
}

function updateHeader() {
    const chapter = CHAPTERS[currentChapter];
    document.getElementById('chapterTitle').textContent = `Kapitel ${currentChapter + 1}: ${chapter.title}`;
    
    const badge = document.getElementById('chapterBadge');
    badge.textContent = chapter.badge;
    badge.className = 'chapter-badge ' + chapter.type;
}

function renderContent() {
    const chapter = CHAPTERS[currentChapter];
    const content = document.getElementById('contentArea');
    
    switch (chapter.type) {
        case 'theory':
        case 'example':
            content.innerHTML = chapter.content;
            break;
        case 'exercise':
            renderExercise(chapter);
            break;
        case 'quiz':
            renderQuiz(chapter);
            break;
        case 'sorting':
            renderSorting(chapter);
            break;
        case 'fillblank':
            renderFillBlank(chapter);
            break;
        case 'result':
            renderResult();
            break;
    }
    
    updateNavButtons();
    updateProgress();
    updateHeader();
}

function renderExercise(chapter) {
    const content = document.getElementById('contentArea');
    
    let html = `
        <div class="content-card">
            <h2>√úbung: Aufgabe ${chapter.taskId}</h2>
            
            <div class="task-text">
                ${chapter.taskText}
                <br><br>
                <strong>Gesucht:</strong> ${chapter.gesucht}
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                <button type="button" class="hint-btn" onclick="showHint()">?</button>
            </div>
            
            <div id="hintContent" class="hint-box">
                <h4>üí° Tipps:</h4>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary);">
                    ${chapter.hints.map(h => `<li>${h}</li>`).join('')}
                </ul>
            </div>
            
            <div class="calc-section">
                <h4>Deine Berechnung:</h4>
                
                <div class="calc-row-simple">
                    <label>MEK (Materialeinzelkosten)</label>
                    <input type="number" id="inp_mek" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
                
                ${chapter.solution.porto !== undefined ? `
                <div class="calc-row-simple">
                    <label>+ Porto/Transport</label>
                    <input type="number" id="inp_porto" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
                ` : ''}
                
                <div class="calc-row-simple">
                    <label>MGK-Zuschlag</label>
                    <input type="number" id="inp_mgk" step="0.1" value="35.4" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Arbeitszeit 1</label>
                    <input type="number" id="inp_min1" step="1" placeholder="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Stundensatz 1</label>
                    <input type="number" id="inp_rate1" step="0.01" value="58.90" inputmode="decimal">
                    <span class="unit">‚Ç¨/h</span>
                </div>
                
                ${chapter.showFert2 ? `
                <div class="calc-row-simple">
                    <label>Arbeitszeit 2</label>
                    <input type="number" id="inp_min2" step="1" placeholder="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Stundensatz 2</label>
                    <input type="number" id="inp_rate2" step="0.01" value="63.40" inputmode="decimal">
                    <span class="unit">‚Ç¨/h</span>
                </div>
                ` : ''}
                
                ${chapter.solution.pausch !== undefined && chapter.solution.pausch > 0 ? `
                <div class="calc-row-simple">
                    <label>+ Pauschale</label>
                    <input type="number" id="inp_pausch" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">‚Ç¨</span>
                </div>
                ` : ''}
                
                <div class="calc-row-simple">
                    <label>Gewinnzuschlag</label>
                    <input type="number" id="inp_gewinn" step="0.1" placeholder="0" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
            </div>
            
            <div class="calc-result-box" id="resultBox" style="display: none;">
                <div class="label">Dein berechneter BVP:</div>
                <div class="value" id="calcResult">0,00 ‚Ç¨</div>
            </div>
            
            <div id="feedbackBox" style="margin-top: 16px;"></div>
        </div>
    `;
    
    content.innerHTML = html;
    
    // Add live calculation
    document.querySelectorAll('.calc-section input').forEach(inp => {
        inp.addEventListener('input', calculateExercise);
    });
}

function calculateExercise() {
    const mek = parseFloat(document.getElementById('inp_mek')?.value) || 0;
    const porto = parseFloat(document.getElementById('inp_porto')?.value) || 0;
    const mgk = parseFloat(document.getElementById('inp_mgk')?.value) || 0;
    const min1 = parseFloat(document.getElementById('inp_min1')?.value) || 0;
    const rate1 = parseFloat(document.getElementById('inp_rate1')?.value) || 0;
    const min2 = parseFloat(document.getElementById('inp_min2')?.value) || 0;
    const rate2 = parseFloat(document.getElementById('inp_rate2')?.value) || 0;
    const pausch = parseFloat(document.getElementById('inp_pausch')?.value) || 0;
    const gewinn = parseFloat(document.getElementById('inp_gewinn')?.value) || 0;
    
    // Calculate
    const mekTotal = mek + porto;
    const mgkAmount = mekTotal * (mgk / 100);
    const mges = mekTotal + mgkAmount;
    const fert1 = (min1 / 60) * rate1;
    const fert2 = (min2 / 60) * rate2;
    const sk = mges + fert1 + fert2 + pausch;
    const nvp = sk * (1 + gewinn / 100);
    const bvp = nvp * 1.19;
    
    // Show result
    const resultBox = document.getElementById('resultBox');
    if (mek > 0 || min1 > 0) {
        resultBox.style.display = 'block';
        document.getElementById('calcResult').textContent = bvp.toFixed(2).replace('.', ',') + ' ‚Ç¨';
    }
    
    return bvp;
}

function checkExercise() {
    const chapter = CHAPTERS[currentChapter];
    const sol = chapter.solution;
    
    // Get user values
    const userMek = parseFloat(document.getElementById('inp_mek')?.value) || 0;
    const userMgk = parseFloat(document.getElementById('inp_mgk')?.value) || 0;
    const userMin1 = parseFloat(document.getElementById('inp_min1')?.value) || 0;
    const userGewinn = parseFloat(document.getElementById('inp_gewinn')?.value) || 0;
    
    // Calculate correct BVP
    const mekTotal = sol.mek + (sol.porto || 0);
    const mgkAmount = mekTotal * (sol.mgk / 100);
    const mges = mekTotal + mgkAmount;
    const fert1 = (sol.min1 / 60) * sol.rate1;
    const fert2 = sol.min2 ? (sol.min2 / 60) * sol.rate2 : 0;
    const sk = mges + fert1 + fert2 + (sol.pausch || 0);
    const nvp = sk * (1 + sol.gewinn / 100);
    const correctBvp = nvp * 1.19;
    
    // Get user BVP
    const userBvp = calculateExercise();
    
    // Check (with 1‚Ç¨ tolerance)
    const isCorrect = Math.abs(userBvp - correctBvp) < 1;
    
    // Track result
    sessionStats.total++;
    if (isCorrect) {
        sessionStats.correct++;
        exerciseResults.push({ taskId: chapter.taskId, correct: true });
    } else {
        sessionStats.wrong++;
        exerciseResults.push({ taskId: chapter.taskId, correct: false });
    }
    
    // Show feedback
    const feedbackBox = document.getElementById('feedbackBox');
    if (isCorrect) {
        feedbackBox.innerHTML = `
            <div style="background: rgba(0, 204, 136, 0.2); border: 1px solid var(--success); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
                <strong style="color: var(--success);">Richtig!</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">Korrekte L√∂sung: ${correctBvp.toFixed(2).replace('.', ',')} ‚Ç¨</p>
            </div>
        `;
    } else {
        feedbackBox.innerHTML = `
            <div style="background: rgba(255, 82, 82, 0.2); border: 1px solid var(--danger); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px;">‚ùå</div>
                <strong style="color: var(--danger);">Nicht ganz richtig</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">
                    Dein Ergebnis: ${userBvp.toFixed(2).replace('.', ',')} ‚Ç¨<br>
                    Richtig w√§re: ${correctBvp.toFixed(2).replace('.', ',')} ‚Ç¨
                </p>
            </div>
        `;
    }
    
    // Enable next button
    document.getElementById('nextBtn').disabled = false;
    
    return isCorrect;
}

function renderQuiz(chapter) {
    const content = document.getElementById('contentArea');
    quizAnswers = new Array(chapter.questions.length).fill(-1);
    
    let html = `<div class="content-card"><h2>Quiz: Teste dein Wissen!</h2>
        <p class="text-muted" style="margin-bottom: 16px;">W√§hle die richtigen Antworten oder √ºberspringe mit dem Button unten.</p>`;
    
    chapter.questions.forEach((q, qIndex) => {
        html += `
            <div style="margin-bottom: 24px;">
                <p style="font-weight: 600; margin-bottom: 12px;">${qIndex + 1}. ${q.q}</p>
                ${q.options.map((opt, oIndex) => `
                    <div class="quiz-option" data-q="${qIndex}" data-o="${oIndex}" onclick="selectQuizOption(${qIndex}, ${oIndex})">
                        <div class="radio"></div>
                        <span>${opt}</span>
                    </div>
                `).join('')}
            </div>
        `;
    });
    
    html += `
        <button type="button" class="btn btn-primary btn-block" id="checkQuizBtn" onclick="checkQuiz()">
            Antworten pr√ºfen
        </button>
        <div id="quizFeedback"></div>
    </div>`;
    
    content.innerHTML = html;
}

function selectQuizOption(qIndex, oIndex) {
    quizAnswers[qIndex] = oIndex;
    
    // Update UI
    document.querySelectorAll(`.quiz-option[data-q="${qIndex}"]`).forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelector(`.quiz-option[data-q="${qIndex}"][data-o="${oIndex}"]`).classList.add('selected');
}

function checkQuiz() {
    const chapter = CHAPTERS[currentChapter];
    let correct = 0;
    
    chapter.questions.forEach((q, qIndex) => {
        const userAnswer = quizAnswers[qIndex];
        const options = document.querySelectorAll(`.quiz-option[data-q="${qIndex}"]`);
        
        options.forEach((opt, oIndex) => {
            opt.style.pointerEvents = 'none';
            if (oIndex === q.correct) {
                opt.classList.add('correct');
            } else if (oIndex === userAnswer && userAnswer !== q.correct) {
                opt.classList.add('wrong');
            }
        });
        
        if (userAnswer === q.correct) correct++;
    });
    
    // Track stats
    sessionStats.total += chapter.questions.length;
    sessionStats.correct += correct;
    sessionStats.wrong += chapter.questions.length - correct;
    
    // Show feedback
    const feedback = document.getElementById('quizFeedback');
    feedback.innerHTML = `
        <div style="margin-top: 16px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm); text-align: center;">
            <strong>${correct} von ${chapter.questions.length} richtig!</strong>
        </div>
    `;
    
    document.getElementById('checkQuizBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

// ===== SORTING GAME =====
let sortingItems = [];

function renderSorting(chapter) {
    const content = document.getElementById('contentArea');
    // Shuffle items
    sortingItems = [...chapter.items].sort(() => Math.random() - 0.5);
    
    content.innerHTML = `
        <div class="content-card">
            <h2>üéÆ Sortier-Spiel</h2>
            <p>${chapter.instruction}</p>
            <p class="text-muted" style="font-size: 0.85rem;">Du kannst auch √ºberspringen wenn du m√∂chtest.</p>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 16px 0;">
                Tippe auf die Begriffe in der richtigen Reihenfolge:
            </p>
            
            <div class="drag-container" id="sourceItems">
                ${sortingItems.map((item, i) => `
                    <div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>
                `).join('')}
            </div>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 16px 0;">
                Deine Reihenfolge (1 ‚Üí 5):
            </p>
            
            <div class="drop-zone" id="targetZone"></div>
            
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="resetSorting()" style="flex: 1;">
                    ‚Ü©Ô∏è Zur√ºcksetzen
                </button>
                <button type="button" class="btn btn-primary" id="checkSortBtn" onclick="checkSorting()" style="flex: 1;">
                    Pr√ºfen ‚úì
                </button>
            </div>
            
            <div id="sortFeedback"></div>
        </div>
    `;
}

function selectSortItem(el) {
    const item = el.getAttribute('data-item');
    const target = document.getElementById('targetZone');
    
    // Move to target
    el.remove();
    target.innerHTML += `<div class="drag-item" data-item="${item}" onclick="unselectSortItem(this)">${item}</div>`;
}

function unselectSortItem(el) {
    const item = el.getAttribute('data-item');
    const source = document.getElementById('sourceItems');
    
    // Move back to source
    el.remove();
    source.innerHTML += `<div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>`;
}

function resetSorting() {
    const chapter = CHAPTERS[currentChapter];
    sortingItems = [...chapter.items].sort(() => Math.random() - 0.5);
    
    document.getElementById('sourceItems').innerHTML = sortingItems.map(item => `
        <div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>
    `).join('');
    
    document.getElementById('targetZone').innerHTML = '';
    document.getElementById('sortFeedback').innerHTML = '';
    document.getElementById('checkSortBtn').style.display = 'block';
}

function checkSorting() {
    const chapter = CHAPTERS[currentChapter];
    const userOrder = Array.from(document.querySelectorAll('#targetZone .drag-item')).map(el => el.getAttribute('data-item'));
    
    const isCorrect = JSON.stringify(userOrder) === JSON.stringify(chapter.correctOrder);
    
    sessionStats.total++;
    if (isCorrect) {
        sessionStats.correct++;
    } else {
        sessionStats.wrong++;
    }
    
    const target = document.getElementById('targetZone');
    const feedback = document.getElementById('sortFeedback');
    
    if (isCorrect) {
        target.classList.add('correct');
        feedback.innerHTML = `
            <div style="margin-top: 16px; padding: 16px; background: rgba(0, 204, 136, 0.2); border: 1px solid var(--success); border-radius: var(--radius-sm); text-align: center;">
                <strong style="color: var(--success);">‚úÖ Perfekt!</strong>
            </div>
        `;
    } else {
        target.classList.add('wrong');
        feedback.innerHTML = `
            <div style="margin-top: 16px; padding: 16px; background: rgba(255, 82, 82, 0.2); border: 1px solid var(--danger); border-radius: var(--radius-sm); text-align: center;">
                <strong style="color: var(--danger);">‚ùå Nicht ganz richtig</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">
                    Richtige Reihenfolge: ${chapter.correctOrder.join(' ‚Üí ')}
                </p>
            </div>
        `;
    }
    
    document.getElementById('checkSortBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

// ===== FILL IN THE BLANK GAME =====
function renderFillBlank(chapter) {
    const content = document.getElementById('contentArea');
    
    let html = `
        <div class="content-card">
            <h2>‚úèÔ∏è L√ºckentext</h2>
            <p>${chapter.instruction}</p>
            <p class="text-muted" style="font-size: 0.85rem;">Du kannst auch √ºberspringen wenn du m√∂chtest.</p>
            
            <div style="margin-top: 20px;">
    `;
    
    chapter.blanks.forEach((blank, i) => {
        // Split text at ___
        const parts = blank.text.split('___');
        html += `
            <div style="margin-bottom: 20px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm);">
                <p style="font-size: 1.1rem; line-height: 2;">
                    ${parts[0]}
                    <span class="fill-blank">
                        <input type="text" id="blank_${i}" placeholder="?" data-answer="${blank.answer}" style="width: 70px;">
                    </span>
                    ${parts[1] || ''}
                </p>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">üí° ${blank.hint}</p>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <button type="button" class="btn btn-primary btn-block" id="checkBlankBtn" onclick="checkFillBlank()">
                Pr√ºfen ‚úì
            </button>
            
            <div id="blankFeedback"></div>
        </div>
    `;
    
    content.innerHTML = html;
}

function checkFillBlank() {
    const chapter = CHAPTERS[currentChapter];
    let correct = 0;
    
    chapter.blanks.forEach((blank, i) => {
        const input = document.getElementById(`blank_${i}`);
        const userAnswer = input.value.trim().replace(',', '.');
        const correctAnswer = blank.answer.replace(',', '.');
        
        input.disabled = true;
        
        if (userAnswer === correctAnswer) {
            input.classList.add('correct');
            correct++;
        } else {
            input.classList.add('wrong');
            input.value = blank.answer;
        }
    });
    
    sessionStats.total += chapter.blanks.length;
    sessionStats.correct += correct;
    sessionStats.wrong += chapter.blanks.length - correct;
    
    const feedback = document.getElementById('blankFeedback');
    feedback.innerHTML = `
        <div style="margin-top: 16px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm); text-align: center;">
            <strong>${correct} von ${chapter.blanks.length} richtig!</strong>
        </div>
    `;
    
    document.getElementById('checkBlankBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

function renderResult() {
    const content = document.getElementById('contentArea');
    const accuracy = sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;
    
    content.innerHTML = `
        <div class="result-hero">
            <div style="font-size: 4rem;">üèÜ</div>
            <h2>Kurs abgeschlossen!</h2>
            <p style="color: var(--text-muted);">Du hast alle Kapitel durchgearbeitet.</p>
        </div>
        
        <div class="content-card">
            <h2>Deine Ergebnisse</h2>
            
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="number">${sessionStats.correct}</div>
                    <div class="label">Richtig</div>
                </div>
                <div class="stat-item">
                    <div class="number">${sessionStats.wrong}</div>
                    <div class="label">Falsch</div>
                </div>
                <div class="stat-item">
                    <div class="number">${accuracy}%</div>
                    <div class="label">Genauigkeit</div>
                </div>
                <div class="stat-item">
                    <div class="number">${CHAPTERS.length}</div>
                    <div class="label">Kapitel</div>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Was du gelernt hast</h2>
            <ul style="color: var(--text-secondary); line-height: 2; padding-left: 20px;">
                <li>Das Kalkulationsschema (MEK ‚Üí BVP)</li>
                <li>MGK-Zuschlagss√§tze (32,8% / 35,4% / 108%)</li>
                <li>Fertigungskostenberechnung</li>
                <li>Der Porto-Trick bei Otoplastik</li>
                <li>Vorw√§rts- und R√ºckw√§rtsrechnung</li>
            </ul>
        </div>
        
        <div class="nav-buttons">
            <button type="button" class="btn btn-secondary" onclick="restartCourse()">
                üîÑ Kurs wiederholen
            </button>
            <a href="./profil.html" class="btn btn-primary" style="text-decoration: none;">
                üë§ Zum Profil
            </a>
        </div>
    `;
    
    // Hide default nav
    document.getElementById('navButtons').style.display = 'none';
    
    // Save progress to profile
    saveProgress();
}

function saveProgress() {
    try {
        localStorage.setItem('kurs_completed', 'true');
        localStorage.setItem('kurs_stats', JSON.stringify(sessionStats));
    } catch (e) {}
}

function loadProgress() {
    try {
        const saved = localStorage.getItem('kurs_chapter');
        if (saved) {
            currentChapter = parseInt(saved) || 0;
        }
    } catch (e) {}
}

function saveChapter() {
    try {
        localStorage.setItem('kurs_chapter', currentChapter.toString());
    } catch (e) {}
}

function restartCourse() {
    currentChapter = 0;
    sessionStats = { correct: 0, wrong: 0, total: 0 };
    exerciseResults = [];
    quizAnswers = [];
    saveChapter();
    document.getElementById('navButtons').style.display = 'grid';
    renderContent();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateNavButtons() {
    const chapter = CHAPTERS[currentChapter];
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const navButtons = document.getElementById('navButtons');
    
    prevBtn.disabled = currentChapter === 0;
    
    // Always allow navigation - user can skip or go back freely
    nextBtn.disabled = false;
    nextBtn.textContent = 'Weiter ‚Üí';
    nextBtn.onclick = goNext;
    
    // Show/hide skip button based on chapter type
    if (chapter.type === 'exercise' || chapter.type === 'quiz' || chapter.type === 'sorting' || chapter.type === 'fillblank') {
        skipBtn.style.display = 'flex';
        navButtons.style.gridTemplateColumns = '1fr 1fr 1fr';
        
        // For exercises, offer "Pr√ºfen" as the main action but still allow skip
        if (chapter.type === 'exercise') {
            nextBtn.textContent = 'Pr√ºfen ‚úì';
            nextBtn.onclick = () => {
                checkExercise();
                nextBtn.textContent = 'Weiter ‚Üí';
                nextBtn.onclick = goNext;
            };
        }
    } else {
        skipBtn.style.display = 'none';
        navButtons.style.gridTemplateColumns = '1fr 1fr';
    }
    
    // Hide everything for result page
    if (chapter.type === 'result') {
        navButtons.style.display = 'none';
    } else {
        navButtons.style.display = 'grid';
    }
}

function goPrev() {
    if (currentChapter > 0) {
        currentChapter--;
        saveChapter();
        renderContent();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goNext() {
    if (currentChapter < CHAPTERS.length - 1) {
        currentChapter++;
        saveChapter();
        renderContent();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function showHint() {
    const hintBox = document.getElementById('hintContent');
    hintBox.classList.toggle('show');
}

function closeHint() {
    document.getElementById('hintModal').classList.remove('show');
}

// ===== CHAPTER HELP =====
const CHAPTER_HELP = {
    1: {
        title: "Hilfe: Einf√ºhrung",
        content: `
            <h4>Was lernst du hier?</h4>
            <p>In diesem Kapitel lernst du die Grundlagen der Kalkulation:</p>
            <ul>
                <li><strong>Kalkulation</strong> = Preisberechnung vom Einkauf zum Verkauf</li>
                <li>Das Schema zeigt alle Schritte in der richtigen Reihenfolge</li>
                <li>Jeder Schritt baut auf dem vorherigen auf</li>
            </ul>
            <h4>Tipp</h4>
            <p>Pr√§ge dir die Reihenfolge ein: MEK ‚Üí Mges ‚Üí Sk ‚Üí NVP ‚Üí BVP</p>
        `
    },
    2: {
        title: "Hilfe: Zuschl√§ge",
        content: `
            <h4>Die drei MGK-S√§tze</h4>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>üîä H√∂rger√§te</td><td style="text-align: right; color: var(--accent);"><strong>32,8%</strong></td></tr>
                <tr><td>üëÇ Otoplastik/Material</td><td style="text-align: right; color: var(--success);"><strong>35,4%</strong></td></tr>
                <tr><td>‚è∞ Handelswaren</td><td style="text-align: right; color: var(--warning);"><strong>108%</strong></td></tr>
            </table>
            <h4>Stundens√§tze</h4>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>HG-Anpassung</td><td style="text-align: right;">60,50 ‚Ç¨/h</td></tr>
                <tr><td>Audiometrie</td><td style="text-align: right;">63,40 ‚Ç¨/h</td></tr>
                <tr><td>Werkstatt</td><td style="text-align: right;">58,90 ‚Ç¨/h</td></tr>
            </table>
            <h4>Eselsbr√ºcke</h4>
            <p>üì¶ <strong>H</strong>andelswaren = <strong>H</strong>√∂chster Satz (108%)</p>
        `
    },
    3: {
        title: "Hilfe: Beispielrechnung",
        content: `
            <h4>Schritt-f√ºr-Schritt</h4>
            <ol style="line-height: 2;">
                <li><strong>MEK</strong> = Einkaufspreis + Porto</li>
                <li><strong>MGK</strong> = MEK √ó Zuschlag%</li>
                <li><strong>Mges</strong> = MEK + MGK</li>
                <li><strong>Fert</strong> = (Minuten √∑ 60) √ó Stundensatz</li>
                <li><strong>Sk</strong> = Mges + Fertigung</li>
                <li><strong>NVP</strong> = Sk √ó (1 + Gewinn%)</li>
                <li><strong>BVP</strong> = NVP √ó 1,19</li>
            </ol>
        `
    },
    4: {
        title: "Hilfe: Aufgabe 3 (Reparatur)",
        content: `
            <h4>Was ist gegeben?</h4>
            <ul>
                <li>Ersatzteil: <strong>65,50 ‚Ç¨</strong> ‚Üí Das ist dein MEK</li>
                <li>Arbeitszeit: <strong>35 Minuten</strong> Werkstatt</li>
                <li>Gewinn: <strong>9%</strong></li>
                <li>Pauschale: <strong>6,95 ‚Ç¨</strong> ‚Üí Zu Selbstkosten addieren!</li>
            </ul>
            <h4>Welche Werte eintragen?</h4>
            <ul>
                <li>MEK: 65,50</li>
                <li>MGK: 35,4% (Material/Reparatur)</li>
                <li>Minuten: 35</li>
                <li>Rate: 58,90 (Werkstatt)</li>
                <li>Pauschale: 6,95</li>
                <li>Gewinn: 9</li>
            </ul>
        `
    },
    5: {
        title: "Hilfe: Handelswaren",
        content: `
            <h4>Was sind Handelswaren?</h4>
            <p>Produkte, die der Akustiker nicht selbst herstellt:</p>
            <ul>
                <li>Wecksysteme / Lichtwecker</li>
                <li>Batterien</li>
                <li>Pflegeprodukte</li>
                <li>Zubeh√∂r</li>
            </ul>
            <h4>Warum 108% MGK?</h4>
            <p>Der hohe Zuschlag deckt Lager, Beratung und Vertrieb ab, da keine eigene Fertigung stattfindet.</p>
        `
    },
    6: {
        title: "Hilfe: Aufgabe 4 (Wecksystem)",
        content: `
            <h4>‚ö†Ô∏è Achtung: Handelsware!</h4>
            <p>Ein Wecksystem ist eine <strong>Handelsware</strong>, daher:</p>
            <ul>
                <li>MGK-Satz: <strong style="color: var(--warning);">108%</strong> (nicht 35,4%!)</li>
            </ul>
            <h4>Werte zum Eintragen:</h4>
            <ul>
                <li>MEK: 55,00</li>
                <li>MGK: <strong>108</strong></li>
                <li>Minuten: 30</li>
                <li>Rate: 60,50 (HG-Anpassung)</li>
                <li>Gewinn: 12</li>
            </ul>
        `
    },
    7: {
        title: "Hilfe: Aufgabe 9 (Otoplastik)",
        content: `
            <h4>‚ö†Ô∏è Der Porto-Trick!</h4>
            <p>Bei Transportkosten gilt:</p>
            <ol>
                <li><strong>ZUERST</strong> Porto zu MEK addieren</li>
                <li><strong>DANN</strong> MGK auf die Summe berechnen</li>
            </ol>
            <h4>Rechnung:</h4>
            <p>MEK = 12,80 + 3,50 = <strong>16,30 ‚Ç¨</strong></p>
            <p>MGK = 16,30 √ó 35,4% = 5,77 ‚Ç¨</p>
            <h4>Werte:</h4>
            <ul>
                <li>MEK: 12,80</li>
                <li>Porto: 3,50</li>
                <li>MGK: 35,4%</li>
            </ul>
        `
    },
    8: {
        title: "Hilfe: Quiz",
        content: `
            <h4>Quiz-Tipps</h4>
            <ul>
                <li>Wecksystem = Handelsware = <strong>108%</strong></li>
                <li>Werkstatt = <strong>58,90 ‚Ç¨/h</strong></li>
                <li>Transportkosten <strong>VOR</strong> MGK addieren</li>
                <li>BVP = NVP √ó <strong>1,19</strong></li>
            </ul>
        `
    },
    9: {
        title: "Hilfe: Aufgabe 6 (Paar HG)",
        content: `
            <h4>Zwei verschiedene Arbeitszeiten!</h4>
            <p>Diese Aufgabe hat zwei Fertigungskosten:</p>
            <ul>
                <li><strong>90 Min</strong> HG-Anpassung @ 60,50 ‚Ç¨/h</li>
                <li><strong>45 Min</strong> Audiometrie @ 63,40 ‚Ç¨/h</li>
            </ul>
            <h4>Berechnung:</h4>
            <p>Fert1 = (90√∑60) √ó 60,50 = 90,75 ‚Ç¨</p>
            <p>Fert2 = (45√∑60) √ó 63,40 = 47,55 ‚Ç¨</p>
            <h4>MGK-Satz:</h4>
            <p>H√∂rger√§te = <strong>32,8%</strong></p>
        `
    },
    10: {
        title: "Hilfe: R√ºckrechnung",
        content: `
            <h4>R√ºckw√§rts = Umkehrung</h4>
            <p>Statt zu addieren/multiplizieren, subtrahierst/dividierst du:</p>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>BVP ‚Üí NVP</td><td style="text-align: right;">√∑ 1,19</td></tr>
                <tr><td>NVP ‚Üí Sk</td><td style="text-align: right;">√∑ (1 + Gewinn%)</td></tr>
                <tr><td>Sk ‚Üí Mges</td><td style="text-align: right;">- Fertigungskosten</td></tr>
                <tr><td>Mges ‚Üí MEK</td><td style="text-align: right;">√∑ (1 + MGK%)</td></tr>
            </table>
        `
    },
    default: {
        title: "Hilfe",
        content: `
            <h4>Allgemeine Tipps</h4>
            <ul>
                <li>Lies die Aufgabe <strong>genau</strong> durch</li>
                <li>Achte auf den <strong>Produkttyp</strong> (H√∂rger√§t, Otoplastik, Handelsware)</li>
                <li>Bei Porto: <strong>Erst addieren</strong>, dann MGK berechnen!</li>
                <li>Fertigungskosten: Minuten √∑ 60 √ó Stundensatz</li>
                <li>Am Ende immer √ó 1,19 f√ºr MwSt</li>
            </ul>
            <h4>H√§ufige Fehler</h4>
            <ul style="color: var(--danger);">
                <li>Falschen MGK-Satz verwenden</li>
                <li>Porto nach der MGK-Berechnung addieren</li>
                <li>MwSt vergessen</li>
            </ul>
        `
    }
};

function showChapterHelp() {
    const chapter = CHAPTERS[currentChapter];
    const help = CHAPTER_HELP[chapter.id] || CHAPTER_HELP.default;
    
    document.getElementById('hintTitle').textContent = help.title;
    document.getElementById('hintBody').innerHTML = help.content;
    document.getElementById('hintModal').classList.add('show');
}

function skip() {
    // Skip without checking - just go to next chapter
    goNext();
}

// ===== INIT =====
document.getElementById('prevBtn').addEventListener('click', goPrev);
document.getElementById('nextBtn').addEventListener('click', goNext);
document.getElementById('skipBtn').addEventListener('click', skip);

// Check profile
STORAGE.onReady(async () => {
    await PROFILES.init();
    
    const profile = PROFILES.getCurrent();
    if (!profile) {
        window.location.href = './index.html';
        return;
    }
    
    loadProgress();
    renderContent();
});
</script>

</body>
</html>
