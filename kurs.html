<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kurs | Kalkulations-Trainer</title>
    <meta name="theme-color" content="#0a0a1a">
    <link rel="icon" href="./icons/icon.svg" type="image/svg+xml">
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        /* Kurs-spezifische Styles */
        .chapter-header {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }
        .chapter-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chapter-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: 4px;
            font-weight: 600;
        }
        .chapter-badge.theory { background: #8b5cf6; color: white; }
        .chapter-badge.exercise { background: var(--accent); }
        .chapter-badge.quiz { background: var(--warning); color: var(--bg-dark); }
        .chapter-badge.result { background: var(--success); color: white; }
        
        .progress-compact {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .progress-bar-mini {
            flex: 1;
            height: 8px;
            background: var(--glass-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-mini .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .content-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
        }
        .content-card h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        .content-card p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 12px;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .info-table td {
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
        }
        .info-table td:first-child {
            color: var(--text-muted);
        }
        .info-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: var(--accent);
        }
        .info-table tr:last-child td {
            border-bottom: none;
        }
        
        .formula-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 16px;
            font-family: monospace;
            font-size: 0.95rem;
            color: var(--accent);
            line-height: 1.8;
            margin: 16px 0;
        }
        
        .example-box {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.1), rgba(0, 204, 136, 0.05));
            border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin: 16px 0;
        }
        .example-box h4 {
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-text {
            background: var(--glass-bg);
            border-left: 4px solid var(--accent);
            padding: 16px;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 20px;
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .calc-section {
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            margin: 16px 0;
        }
        .calc-section h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
        }
        .calc-row-simple {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .calc-row-simple label {
            flex: 1;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .calc-row-simple input {
            width: 100px;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            text-align: right;
        }
        .calc-row-simple input:focus {
            border-color: var(--accent);
            outline: none;
        }
        .calc-row-simple .unit {
            color: var(--text-muted);
            width: 30px;
        }
        .calc-row-simple.readonly input {
            background: transparent;
            border-color: transparent;
            color: var(--accent);
            font-weight: 600;
        }
        .calc-result-box {
            background: linear-gradient(135deg, rgba(0, 245, 212, 0.15), rgba(0, 204, 136, 0.1));
            border: 2px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
            margin-top: 16px;
        }
        .calc-result-box .label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .calc-result-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        /* Quiz Styles */
        .quiz-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-option:hover {
            border-color: var(--accent);
        }
        .quiz-option.selected {
            border-color: var(--accent);
            background: rgba(0, 245, 212, 0.1);
        }
        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.2);
        }
        .quiz-option.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.2);
        }
        .quiz-option .radio {
            width: 24px;
            height: 24px;
            border: 2px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-option.selected .radio {
            border-color: var(--accent);
            background: var(--accent);
        }
        .quiz-option.selected .radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 50%;
        }
        
        /* Drag & Drop */
        .drag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px;
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            min-height: 60px;
            margin-bottom: 12px;
        }
        .drag-item {
            padding: 10px 16px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: grab;
            user-select: none;
            touch-action: none;
        }
        .drag-item:active {
            cursor: grabbing;
        }
        .drop-zone {
            display: flex;
            gap: 8px;
            padding: 16px;
            background: var(--bg-dark);
            border: 2px dashed var(--glass-border);
            border-radius: var(--radius-sm);
            min-height: 60px;
            flex-wrap: wrap;
        }
        .drop-zone.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.1);
        }
        .drop-zone.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.1);
        }
        
        /* Fill in the blank */
        .fill-blank {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .fill-blank input {
            width: 80px;
            padding: 8px;
            background: var(--bg-dark);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            font-weight: 600;
        }
        .fill-blank input:focus {
            border-color: var(--accent);
            outline: none;
        }
        .fill-blank input.correct {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.2);
        }
        .fill-blank input.wrong {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.2);
        }
        
        /* Navigation */
        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .nav-buttons.single {
            grid-template-columns: 1fr;
        }
        
        /* Results */
        .result-hero {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(0, 204, 136, 0.2), rgba(0, 245, 212, 0.1));
            border: 2px solid var(--success);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        .result-hero .icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
        .result-hero h2 {
            color: var(--success);
            margin-bottom: 8px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        .stat-item {
            background: var(--glass-bg);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }
        .stat-item .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-item .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Hint button */
        .hint-btn {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 245, 212, 0.3);
        }
        .hint-btn:hover, .hint-btn:active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-dark);
        }
        
        .hint-box {
            display: none;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.1));
            border: 1px solid #8b5cf6;
            border-radius: var(--radius-sm);
            padding: 16px;
            margin-top: 12px;
        }
        .hint-box.show {
            display: block;
        }
        .hint-box h4 {
            color: #a78bfa;
            margin-bottom: 8px;
        }
        
        /* Floating Help Button */
        .floating-help-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .floating-help-btn:hover,
        .floating-help-btn:active {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        
        /* Skip button style */
        .btn-skip {
            background: transparent !important;
            border-color: var(--text-muted) !important;
            color: var(--text-muted) !important;
            font-size: 0.85rem;
        }
        .btn-skip:hover {
            border-color: var(--accent) !important;
            color: var(--accent) !important;
        }
        
        /* Flashcard Styles */
        .flashcard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px 0;
            position: relative;
            overflow: visible;
        }
        .flashcard {
            width: 100%;
            max-width: 320px;
            height: 200px;
            perspective: 1000px;
            cursor: pointer;
            position: relative;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-inner.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: var(--radius);
            font-size: 1.3rem;
            font-weight: 600;
            box-sizing: border-box;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--accent);
            color: var(--text-primary);
            z-index: 2;
        }
        .flashcard-back {
            background: linear-gradient(135deg, var(--accent), #00b894);
            color: var(--bg-dark);
            transform: rotateY(180deg);
            z-index: 1;
        }
        .flashcard-progress {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .flashcard-controls {
            display: flex;
            gap: 12px;
        }
        
        /* Matching Game Styles */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .match-item {
            padding: 14px 16px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .match-item:hover {
            border-color: var(--accent);
        }
        .match-item.selected {
            border-color: var(--accent);
            background: rgba(0, 245, 212, 0.15);
        }
        .match-item.matched {
            border-color: var(--success);
            background: rgba(0, 204, 136, 0.2);
            cursor: default;
            opacity: 0.7;
        }
        .match-item.wrong-match {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.2);
            animation: shake 0.3s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-particles"></div>

<div class="container">

    <!-- Chapter Header with Progress -->
    <div class="chapter-header">
        <div class="chapter-title">
            <span id="chapterTitle">Kapitel 1: Einführung</span>
            <span class="chapter-badge theory" id="chapterBadge">Theorie</span>
        </div>
        <div class="progress-compact">
            <div class="progress-bar-mini">
                <div class="fill" id="progressFill" style="width: 0%"></div>
            </div>
            <span class="progress-text" id="progressText">1 / 12</span>
        </div>
    </div>

    <!-- Content Area (filled by JS) -->
    <div id="contentArea">
        <!-- Dynamic content -->
    </div>

    <!-- Navigation Buttons -->
    <div class="nav-buttons" id="navButtons" style="grid-template-columns: 1fr 1fr 1fr;">
        <button type="button" class="btn btn-secondary" id="prevBtn" disabled>
            ← Zurück
        </button>
        <button type="button" class="btn btn-secondary" id="skipBtn" style="background: transparent; border-color: var(--text-muted); color: var(--text-muted);">
            Überspringen
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
            Weiter →
        </button>
    </div>
    
    <!-- Help Button (floating) -->
    <button type="button" class="floating-help-btn" id="floatingHelpBtn" onclick="showChapterHelp()">
        ?
    </button>

</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <a href="./kurs.html" class="nav-item active">
        <svg class="icon" viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"></path></svg>
        <span>Kurs</span>
    </a>
    <a href="./profil.html" class="nav-item">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Profil</span>
    </a>
</nav>

<!-- Hint Modal -->
<div class="modal-overlay" id="hintModal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="hintTitle">Hilfe</h3>
            <button type="button" class="modal-close" onclick="closeHint()">×</button>
        </div>
        <div class="modal-body" id="hintBody"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-block" onclick="closeHint()">Verstanden</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="./js/storage.js?v=7"></script>
<script src="./js/profanity.js?v=7"></script>
<script src="./js/profiles.js?v=7"></script>
<script src="./js/generator.js?v=7"></script>
<script>
// ===== KURS DATEN =====
const CHAPTERS = [
    // Kapitel 1: Einführung
    {
        id: 1,
        title: "Einführung",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>Was ist Kalkulation?</h2>
                <p>
                    Die <strong>Kalkulation</strong> ist die Berechnung des Verkaufspreises für ein Produkt oder eine Dienstleistung.
                </p>
                <p>
                    Du startest beim <strong>Einkaufspreis</strong> und rechnest Schritt für Schritt alle Kosten und Zuschläge dazu, bis du beim <strong>Bruttoverkaufspreis (BVP)</strong> landest.
                </p>
                
                <div class="example-box">
                    <h4>Das Kalkulationsschema</h4>
                    <div class="formula-box">
Listenpreis / Einkauf<br>
+ Bezugskosten (Porto)<br>
<strong style="color: var(--accent);">= MEK (Materialeinzelkosten)</strong><br>
+ MGK (Materialgemeinkosten)<br>
<strong style="color: var(--accent);">= Mges (Materialgesamtkosten)</strong><br>
+ Fertigungskosten<br>
<strong style="color: var(--success);">= Sk (Selbstkosten)</strong><br>
+ Gewinn<br>
<strong style="color: var(--success);">= NVP (Nettoverkaufspreis)</strong><br>
+ MwSt (19%)<br>
<strong style="color: var(--warning);">= BVP (Bruttoverkaufspreis)</strong>
                    </div>
                </div>
            </div>
        `
    },
    
    // Kapitel 2: Die Zuschläge
    {
        id: 2,
        title: "Die Zuschläge",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>MGK-Zuschlagssätze</h2>
                <p>
                    Die <strong>Materialgemeinkosten (MGK)</strong> decken Kosten ab, die nicht direkt einem Produkt zugeordnet werden können (z.B. Lager, Verwaltung).
                </p>
                <p>
                    Je nach Produktart gibt es unterschiedliche Zuschlagssätze:
                </p>
                
                <table class="info-table">
                    <tr>
                        <td>Hörgeräte</td>
                        <td style="color: var(--accent);">32,8 %</td>
                    </tr>
                    <tr>
                        <td>Otoplastik / Material</td>
                        <td style="color: var(--success);">35,4 %</td>
                    </tr>
                    <tr>
                        <td>Handelswaren (Wecker, Batterien)</td>
                        <td style="color: var(--warning);">108 %</td>
                    </tr>
                </table>
                
                <div class="example-box">
                    <h4>Wichtig zu merken</h4>
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong>Handelswaren</strong> wie Wecksysteme, Batterien, Pflegeprodukte haben den höchsten MGK-Satz von <strong style="color: var(--warning);">108%</strong>!
                    </p>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Fertigungsstundensätze</h2>
                <p>Die Fertigungskosten werden nach Arbeitszeit berechnet:</p>
                
                <table class="info-table">
                    <tr>
                        <td>HG-Anpassung</td>
                        <td>60,50 €/h</td>
                    </tr>
                    <tr>
                        <td>Audiometrie</td>
                        <td>63,40 €/h</td>
                    </tr>
                    <tr>
                        <td>Werkstatt / Labor</td>
                        <td>58,90 €/h</td>
                    </tr>
                </table>
                
                <div class="formula-box">
                    <strong>Formel:</strong><br>
                    Fertigungskosten = (Minuten ÷ 60) × Stundensatz
                </div>
            </div>
        `
    },
    
    // Kapitel 3: Erste Rechnung (Beispiel)
    {
        id: 3,
        title: "Erste Rechnung",
        type: "example",
        badge: "Beispiel",
        content: `
            <div class="content-card">
                <h2>Schritt-für-Schritt Beispiel</h2>
                
                <div class="task-text">
                    <strong>Aufgabe:</strong> Ein Ersatzteil kostet <strong>65,50 €</strong>. 
                    Die Reparatur dauert <strong>35 Minuten</strong> in der Werkstatt. 
                    Der Gewinnzuschlag beträgt <strong>9%</strong>.
                    Berechne den Bruttoverkaufspreis.
                </div>
                
                <div class="calc-section">
                    <h4>Lösung:</h4>
                    
                    <div class="formula-box">
<strong>1. MEK ermitteln:</strong><br>
   MEK = 65,50 € (Ersatzteil, kein Porto)<br><br>

<strong>2. MGK berechnen:</strong><br>
   MGK-Satz für Material = 35,4%<br>
   MGK = 65,50 × 0,354 = 23,19 €<br><br>

<strong>3. Mges = MEK + MGK:</strong><br>
   Mges = 65,50 + 23,19 = 88,69 €<br><br>

<strong>4. Fertigungskosten:</strong><br>
   Fert = (35 ÷ 60) × 58,90 = 34,36 €<br><br>

<strong>5. Selbstkosten:</strong><br>
   Sk = 88,69 + 34,36 = 123,05 €<br><br>

<strong>6. Gewinn addieren (9%):</strong><br>
   NVP = 123,05 × 1,09 = 134,12 €<br><br>

<strong>7. MwSt addieren (19%):</strong><br>
   BVP = 134,12 × 1,19 = <span style="color: var(--success); font-size: 1.2em;">159,60 €</span>
                    </div>
                </div>
            </div>
        `
    },
    
    // Kapitel 4: Erste eigene Übung
    {
        id: 4,
        title: "Selber rechnen",
        type: "exercise",
        badge: "Übung",
        taskId: 3,
        taskText: "Ein Kunde bringt ein Hörgerät zur Reparatur. Das Ersatzteil kostet <strong>65,50 €</strong>. Die Reparatur dauert <strong>35 Minuten</strong> in der Werkstatt. Der Gewinnzuschlag beträgt <strong>9%</strong>. Außerdem wird eine Pauschale von <strong>6,95 €</strong> berechnet.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MGK-Satz: 35,4% (Material/Reparatur)", "Stundensatz Werkstatt: 58,90 €/h", "Pauschale zu Selbstkosten addieren!"],
        solution: { mek: 65.50, mgk: 35.4, min1: 35, rate1: 58.90, pausch: 6.95, gewinn: 9 }
    },
    
    // Kapitel 5: Handelswaren Theorie
    {
        id: 5,
        title: "Handelswaren",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>Handelswaren: 108% MGK</h2>
                <p>
                    <strong>Handelswaren</strong> sind Produkte, die der Akustiker nicht selbst herstellt, sondern nur weiterverkauft.
                </p>
                
                <div class="example-box">
                    <h4>Beispiele für Handelswaren</h4>
                    <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px;">
                        <li>Wecksysteme / Lichtwecker</li>
                        <li>Batterien</li>
                        <li>Pflegeprodukte</li>
                        <li>Zubehör</li>
                    </ul>
                </div>
                
                <p>
                    Der hohe MGK-Satz von <strong style="color: var(--warning);">108%</strong> berücksichtigt, dass der Händler diese Produkte nur im Sortiment hat und keinen großen Fertigungsaufwand hat.
                </p>
                
                <div class="formula-box">
                    <strong>Beispiel Wecksystem:</strong><br>
                    MEK = 45,00 €<br>
                    MGK = 45,00 × 1,08 = 48,60 €<br>
                    Mges = 45,00 + 48,60 = <strong>93,60 €</strong>
                </div>
            </div>
        `
    },
    
    // Kapitel 6: Wecksystem Übung
    {
        id: 6,
        title: "Wecksystem",
        type: "exercise",
        badge: "Übung",
        taskId: 4,
        taskText: "Ein Kunde möchte ein Wecksystem kaufen. Der Einkaufspreis beträgt <strong>55,00 €</strong>. Beratungszeit: <strong>30 Minuten</strong> (HG-Anpassung). Gewinnzuschlag: <strong>12%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["ACHTUNG: Wecksystem = Handelsware = 108% MGK!", "Stundensatz HG-Anpassung: 60,50 €/h"],
        solution: { mek: 55.00, mgk: 108, min1: 30, rate1: 60.50, pausch: 0, gewinn: 12 }
    },
    
    // Kapitel 7: Otoplastik (Porto-Trick)
    {
        id: 7,
        title: "Otoplastik",
        type: "exercise",
        badge: "Übung",
        taskId: 9,
        taskText: "Für einen Kunden wird eine Otoplastik angefertigt. Materialkosten: <strong>12,80 €</strong>. Transportkosten: <strong>3,50 €</strong>. Arbeitszeit Labor: <strong>25 Minuten</strong>. Gewinnzuschlag: <strong>8%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["WICHTIG: Transportkosten ZUERST zu MEK addieren!", "MGK-Satz Otoplastik: 35,4%", "Dann MGK auf die SUMME berechnen!"],
        solution: { mek: 12.80, porto: 3.50, mgk: 35.4, min1: 25, rate1: 58.90, pausch: 0, gewinn: 8 }
    },
    
    // Kapitel 8: Quiz
    {
        id: 8,
        title: "Quiz-Time",
        type: "quiz",
        badge: "Quiz",
        questions: [
            {
                q: "Welcher MGK-Satz gilt für ein Wecksystem?",
                options: ["32,8%", "35,4%", "108%"],
                correct: 2
            },
            {
                q: "Was ist der Stundensatz für Werkstatt-Arbeiten?",
                options: ["58,90 €/h", "60,50 €/h", "63,40 €/h"],
                correct: 0
            },
            {
                q: "Wann werden Transportkosten addiert?",
                options: ["Nach der MGK-Berechnung", "VOR der MGK-Berechnung zum MEK", "Zum Nettoverkaufspreis"],
                correct: 1
            },
            {
                q: "Wie berechnet man den BVP aus dem NVP?",
                options: ["NVP × 0,19", "NVP + 19", "NVP × 1,19"],
                correct: 2
            }
        ]
    },
    
    // Kapitel 8b: Sortier-Spiel
    {
        id: '8b',
        title: "Reihenfolge",
        type: "sorting",
        badge: "Spiel",
        instruction: "Bringe die Kalkulationsschritte in die richtige Reihenfolge:",
        items: ["BVP", "Selbstkosten", "MEK", "NVP", "Mges"],
        correctOrder: ["MEK", "Mges", "Selbstkosten", "NVP", "BVP"]
    },
    
    // Kapitel 8c: Lückentext
    {
        id: '8c',
        title: "Formeln",
        type: "fillblank",
        badge: "Spiel",
        instruction: "Vervollständige die Formeln:",
        blanks: [
            { text: "Fertigungskosten = Minuten ÷ ___ × Stundensatz", answer: "60", hint: "Minuten in Stunden umrechnen" },
            { text: "BVP = NVP × ___", answer: "1,19", hint: "MwSt-Faktor" },
            { text: "MGK Handelswaren = ___ %", answer: "108", hint: "Der höchste Satz" }
        ]
    },
    
    // Kapitel 9: Paar Hörgeräte
    {
        id: 9,
        title: "Paar Hörgeräte",
        type: "exercise",
        badge: "Übung",
        taskId: 6,
        taskText: "Ein Kunde kauft ein Paar Hörgeräte. Listenpreis für beide: <strong>1.890,00 €</strong>. Anpasszeit: <strong>90 Minuten</strong> (HG-Anpassung). Audiometrie: <strong>45 Minuten</strong>. Gewinnzuschlag: <strong>15%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MGK-Satz Hörgeräte: 32,8%", "Zwei verschiedene Stundensätze!", "HG-Anpassung: 60,50 €/h", "Audiometrie: 63,40 €/h"],
        solution: { mek: 1890.00, mgk: 32.8, min1: 90, rate1: 60.50, min2: 45, rate2: 63.40, pausch: 0, gewinn: 15 },
        showFert2: true
    },
    
    // Kapitel 10: Rückrechnung
    {
        id: 10,
        title: "Rückrechnung",
        type: "theory",
        badge: "Theorie",
        content: `
            <div class="content-card">
                <h2>Rückwärts rechnen</h2>
                <p>
                    Manchmal musst du vom <strong>BVP</strong> zurück zum <strong>MEK</strong> rechnen. Dabei werden alle Schritte <em>umgekehrt</em>.
                </p>
                
                <div class="formula-box">
<strong>Rückrechnung:</strong><br><br>
BVP (gegeben)<br>
÷ 1,19 = NVP<br>
÷ (1 + Gewinn%) = Sk<br>
- Fertigungskosten = Mges<br>
÷ (1 + MGK%) = MEK
                </div>
                
                <div class="example-box">
                    <h4>Beispiel</h4>
                    <p style="color: var(--text-secondary); margin: 0;">
                        BVP = 200,00 €<br>
                        NVP = 200 ÷ 1,19 = 168,07 €<br>
                        Bei 10% Gewinn: Sk = 168,07 ÷ 1,10 = 152,79 €
                    </p>
                </div>
            </div>
        `
    },
    
    // Kapitel 11: Zusätzliche Übung - Batterien
    {
        id: 11,
        title: "Batterien",
        type: "exercise",
        badge: "Übung",
        taskId: 12,
        taskText: "Ein Kunde kauft 6 Packungen Hörgerätebatterien. Einkaufspreis pro Packung: <strong>2,50 €</strong>. Beratungszeit: <strong>10 Minuten</strong> (HG-Anpassung). Gewinnzuschlag: <strong>20%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MEK = 6 × 2,50 = 15,00 €", "Batterien = Handelsware = 108% MGK!", "Stundensatz HG-Anpassung: 60,50 €/h"],
        solution: { mek: 15.00, mgk: 108, min1: 10, rate1: 60.50, pausch: 0, gewinn: 20 }
    },
    
    // Kapitel 12: Zusätzliche Übung - Reinigungsset
    {
        id: 12,
        title: "Reinigungsset",
        type: "exercise",
        badge: "Übung",
        taskId: 13,
        taskText: "Ein Pflegeset für Hörgeräte wird verkauft. Einkaufspreis: <strong>8,90 €</strong>. Versandkosten: <strong>1,50 €</strong>. Keine Beratung nötig. Gewinnzuschlag: <strong>25%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["Pflegeset = Handelsware = 108% MGK", "Versandkosten ZUERST addieren!", "Keine Fertigungskosten"],
        solution: { mek: 8.90, porto: 1.50, mgk: 108, min1: 0, rate1: 0, pausch: 0, gewinn: 25 }
    },
    
    // Kapitel 13: Schnelltest - Flashcards
    {
        id: 13,
        title: "Schnelltest",
        type: "flashcard",
        badge: "Spiel",
        cards: [
            { front: "MGK-Satz Hörgeräte?", back: "32,8 %" },
            { front: "MGK-Satz Otoplastik?", back: "35,4 %" },
            { front: "MGK-Satz Handelswaren?", back: "108 %" },
            { front: "Stundensatz Werkstatt?", back: "58,90 €/h" },
            { front: "Stundensatz HG-Anpassung?", back: "60,50 €/h" },
            { front: "Stundensatz Audiometrie?", back: "63,40 €/h" },
            { front: "MwSt-Faktor?", back: "× 1,19" },
            { front: "Was sind Handelswaren?", back: "Batterien, Wecker, Zubehör" }
        ]
    },
    
    // Kapitel 14: Zuordnungsspiel
    {
        id: 14,
        title: "Zuordnung",
        type: "matching",
        badge: "Spiel",
        instruction: "Ordne die Begriffe richtig zu:",
        pairs: [
            { left: "Wecksystem", right: "108 %" },
            { left: "Otoplastik", right: "35,4 %" },
            { left: "Hörgerät", right: "32,8 %" },
            { left: "Werkstatt", right: "58,90 €/h" }
        ]
    },
    
    // Kapitel 15: Abschlusstest
    {
        id: 15,
        title: "Abschlusstest",
        type: "exercise",
        badge: "Prüfung",
        taskId: 11,
        taskText: "Für einen Kunden wird ein individueller Gehörschutz angefertigt. Materialmenge: <strong>15,60 €</strong>. Dazu 2 Filter à <strong>4,20 €</strong>. Arbeitszeit Labor: <strong>40 Minuten</strong>. Gewinnzuschlag: <strong>10%</strong>.",
        gesucht: "Bruttoverkaufspreis (BVP)",
        hints: ["MEK = Material + 2 × Filter = 24,00 €", "MGK-Satz Material: 35,4%", "Stundensatz Werkstatt: 58,90 €/h"],
        solution: { mek: 24.00, mgk: 35.4, min1: 40, rate1: 58.90, pausch: 0, gewinn: 10 }
    },
    
    // Kapitel 16: Lerntipps
    {
        id: 16,
        title: "Lerntipps",
        type: "theory",
        badge: "Tipps",
        content: `
            <div class="content-card">
                <h2>So merkst du dir alles!</h2>
                
                <div class="example-box" style="margin-bottom: 20px;">
                    <h4>MGK-Sätze merken</h4>
                    <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 2;">
                        <strong>H</strong>andelswaren = <strong>H</strong>öchster Satz = <strong>108%</strong><br>
                        <strong>O</strong>toplastik = <strong>O</strong>hne viel Aufwand = <strong>35,4%</strong><br>
                        <strong>H</strong>örgeräte = <strong>H</strong>auptsache = <strong>32,8%</strong>
                    </p>
                </div>
                
                <div class="example-box" style="margin-bottom: 20px;">
                    <h4>Stundensätze merken</h4>
                    <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 2;">
                        <strong>W</strong>erkstatt = 58,90 (fast <strong>59</strong>)<br>
                        <strong>A</strong>npassung = 60,50 (genau <strong>60,50</strong>)<br>
                        <strong>A</strong>udiometrie = 63,40 (höchster, weil teuer)
                    </p>
                </div>
                
                <div class="example-box" style="margin-bottom: 20px;">
                    <h4>Die Reihenfolge</h4>
                    <p style="color: var(--text-secondary); font-size: 1.1rem;">
                        Merksatz: <strong>"Mein Mensch Sucht Neue Bücher"</strong>
                    </p>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        <strong>M</strong>EK → <strong>M</strong>ges → <strong>S</strong>k → <strong>N</strong>VP → <strong>B</strong>VP
                    </p>
                </div>
                
                <div class="example-box" style="margin-bottom: 20px;">
                    <h4>Der Porto-Trick</h4>
                    <p style="color: var(--text-secondary);">
                        <strong>ZUERST Porto, DANN Prozent!</strong><br>
                        Transportkosten immer VOR der MGK-Berechnung zum MEK addieren.
                    </p>
                </div>
                
                <div class="example-box">
                    <h4>Häufige Fehler vermeiden</h4>
                    <ul style="color: var(--text-secondary); line-height: 2;">
                        <li>Falsche MGK: Ist es eine <strong>Handelsware</strong>? → 108%!</li>
                        <li>Porto vergessen: Immer prüfen ob Versand dabei ist</li>
                        <li>MwSt vergessen: Am Ende IMMER × 1,19</li>
                        <li>Minuten nicht umrechnen: Min ÷ 60 = Stunden</li>
                    </ul>
                </div>
            </div>
        `
    },
    
    // Kapitel 17: Ergebnis
    {
        id: 17,
        title: "Ergebnis",
        type: "result",
        badge: "Abschluss"
    }
];

// ===== STATE =====
let currentChapter = 0;
let quizAnswers = [];
let exerciseResults = [];
let sessionStats = { correct: 0, wrong: 0, total: 0 };

// ===== FUNCTIONS =====

function updateProgress() {
    const progress = Math.round(((currentChapter + 1) / CHAPTERS.length) * 100);
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${currentChapter + 1} / ${CHAPTERS.length}`;
}

function updateHeader() {
    const chapter = CHAPTERS[currentChapter];
    document.getElementById('chapterTitle').textContent = `Kapitel ${currentChapter + 1}: ${chapter.title}`;
    
    const badge = document.getElementById('chapterBadge');
    badge.textContent = chapter.badge;
    badge.className = 'chapter-badge ' + chapter.type;
}

function renderContent() {
    const chapter = CHAPTERS[currentChapter];
    const content = document.getElementById('contentArea');
    
    switch (chapter.type) {
        case 'theory':
        case 'example':
            content.innerHTML = chapter.content;
            break;
        case 'exercise':
            renderExercise(chapter);
            break;
        case 'quiz':
            renderQuiz(chapter);
            break;
        case 'sorting':
            renderSorting(chapter);
            break;
        case 'fillblank':
            renderFillBlank(chapter);
            break;
        case 'flashcard':
            renderFlashcards(chapter);
            break;
        case 'matching':
            renderMatching(chapter);
            break;
        case 'result':
            renderResult();
            break;
    }
    
    updateNavButtons();
    updateProgress();
    updateHeader();
}

function renderExercise(chapter) {
    const content = document.getElementById('contentArea');
    
    let html = `
        <div class="content-card">
            <h2>Übung: Aufgabe ${chapter.taskId}</h2>
            
            <div class="task-text">
                ${chapter.taskText}
                <br><br>
                <strong>Gesucht:</strong> ${chapter.gesucht}
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                <button type="button" class="hint-btn" onclick="showHint()">?</button>
            </div>
            
            <div id="hintContent" class="hint-box">
                <h4>Tipps:</h4>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary);">
                    ${chapter.hints.map(h => `<li>${h}</li>`).join('')}
                </ul>
            </div>
            
            <div class="calc-section">
                <h4>Deine Berechnung:</h4>
                
                <div class="calc-row-simple">
                    <label>MEK (Materialeinzelkosten)</label>
                    <input type="number" id="inp_mek" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">€</span>
                </div>
                
                ${chapter.solution.porto !== undefined ? `
                <div class="calc-row-simple">
                    <label>+ Porto/Transport</label>
                    <input type="number" id="inp_porto" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">€</span>
                </div>
                ` : ''}
                
                <div class="calc-row-simple">
                    <label>MGK-Zuschlag</label>
                    <input type="number" id="inp_mgk" step="0.1" value="35.4" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Arbeitszeit 1</label>
                    <input type="number" id="inp_min1" step="1" placeholder="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Stundensatz 1</label>
                    <input type="number" id="inp_rate1" step="0.01" value="58.90" inputmode="decimal">
                    <span class="unit">€/h</span>
                </div>
                
                ${chapter.showFert2 ? `
                <div class="calc-row-simple">
                    <label>Arbeitszeit 2</label>
                    <input type="number" id="inp_min2" step="1" placeholder="0" inputmode="numeric">
                    <span class="unit">min</span>
                </div>
                
                <div class="calc-row-simple">
                    <label>Stundensatz 2</label>
                    <input type="number" id="inp_rate2" step="0.01" value="63.40" inputmode="decimal">
                    <span class="unit">€/h</span>
                </div>
                ` : ''}
                
                ${chapter.solution.pausch !== undefined && chapter.solution.pausch > 0 ? `
                <div class="calc-row-simple">
                    <label>+ Pauschale</label>
                    <input type="number" id="inp_pausch" step="0.01" placeholder="0,00" inputmode="decimal">
                    <span class="unit">€</span>
                </div>
                ` : ''}
                
                <div class="calc-row-simple">
                    <label>Gewinnzuschlag</label>
                    <input type="number" id="inp_gewinn" step="0.1" placeholder="0" inputmode="decimal">
                    <span class="unit">%</span>
                </div>
            </div>
            
            <div class="calc-result-box" id="resultBox" style="display: none;">
                <div class="label">Dein berechneter BVP:</div>
                <div class="value" id="calcResult">0,00 €</div>
            </div>
            
            <div id="feedbackBox" style="margin-top: 16px;"></div>
        </div>
    `;
    
    content.innerHTML = html;
    
    // Add live calculation
    document.querySelectorAll('.calc-section input').forEach(inp => {
        inp.addEventListener('input', calculateExercise);
    });
}

function calculateExercise() {
    const mek = parseFloat(document.getElementById('inp_mek')?.value) || 0;
    const porto = parseFloat(document.getElementById('inp_porto')?.value) || 0;
    const mgk = parseFloat(document.getElementById('inp_mgk')?.value) || 0;
    const min1 = parseFloat(document.getElementById('inp_min1')?.value) || 0;
    const rate1 = parseFloat(document.getElementById('inp_rate1')?.value) || 0;
    const min2 = parseFloat(document.getElementById('inp_min2')?.value) || 0;
    const rate2 = parseFloat(document.getElementById('inp_rate2')?.value) || 0;
    const pausch = parseFloat(document.getElementById('inp_pausch')?.value) || 0;
    const gewinn = parseFloat(document.getElementById('inp_gewinn')?.value) || 0;
    
    // Calculate
    const mekTotal = mek + porto;
    const mgkAmount = mekTotal * (mgk / 100);
    const mges = mekTotal + mgkAmount;
    const fert1 = (min1 / 60) * rate1;
    const fert2 = (min2 / 60) * rate2;
    const sk = mges + fert1 + fert2 + pausch;
    const nvp = sk * (1 + gewinn / 100);
    const bvp = nvp * 1.19;
    
    // Show result
    const resultBox = document.getElementById('resultBox');
    if (mek > 0 || min1 > 0) {
        resultBox.style.display = 'block';
        document.getElementById('calcResult').textContent = bvp.toFixed(2).replace('.', ',') + ' €';
    }
    
    return bvp;
}

function checkExercise() {
    const chapter = CHAPTERS[currentChapter];
    const sol = chapter.solution;
    
    // Get user values
    const userMek = parseFloat(document.getElementById('inp_mek')?.value) || 0;
    const userMgk = parseFloat(document.getElementById('inp_mgk')?.value) || 0;
    const userMin1 = parseFloat(document.getElementById('inp_min1')?.value) || 0;
    const userGewinn = parseFloat(document.getElementById('inp_gewinn')?.value) || 0;
    
    // Calculate correct BVP
    const mekTotal = sol.mek + (sol.porto || 0);
    const mgkAmount = mekTotal * (sol.mgk / 100);
    const mges = mekTotal + mgkAmount;
    const fert1 = (sol.min1 / 60) * sol.rate1;
    const fert2 = sol.min2 ? (sol.min2 / 60) * sol.rate2 : 0;
    const sk = mges + fert1 + fert2 + (sol.pausch || 0);
    const nvp = sk * (1 + sol.gewinn / 100);
    const correctBvp = nvp * 1.19;
    
    // Get user BVP
    const userBvp = calculateExercise();
    
    // Check (with 1€ tolerance)
    const isCorrect = Math.abs(userBvp - correctBvp) < 1;
    
    // Track result
    sessionStats.total++;
    if (isCorrect) {
        sessionStats.correct++;
        exerciseResults.push({ taskId: chapter.taskId, correct: true });
    } else {
        sessionStats.wrong++;
        exerciseResults.push({ taskId: chapter.taskId, correct: false });
    }
    
    // Show feedback
    const feedbackBox = document.getElementById('feedbackBox');
    if (isCorrect) {
        feedbackBox.innerHTML = `
            <div style="background: rgba(0, 204, 136, 0.2); border: 1px solid var(--success); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px; color: var(--success);">&#10003;</div>
                <strong style="color: var(--success);">Richtig!</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">Korrekte Lösung: ${correctBvp.toFixed(2).replace('.', ',')} €</p>
            </div>
        `;
    } else {
        feedbackBox.innerHTML = `
            <div style="background: rgba(255, 82, 82, 0.2); border: 1px solid var(--danger); border-radius: var(--radius-sm); padding: 16px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 8px; color: var(--danger);">&#10007;</div>
                <strong style="color: var(--danger);">Nicht ganz richtig</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">
                    Dein Ergebnis: ${userBvp.toFixed(2).replace('.', ',')} €<br>
                    Richtig wäre: ${correctBvp.toFixed(2).replace('.', ',')} €
                </p>
            </div>
        `;
    }
    
    // Enable next button
    document.getElementById('nextBtn').disabled = false;
    
    return isCorrect;
}

function renderQuiz(chapter) {
    const content = document.getElementById('contentArea');
    quizAnswers = new Array(chapter.questions.length).fill(-1);
    
    let html = `<div class="content-card"><h2>Quiz: Teste dein Wissen!</h2>
        <p class="text-muted" style="margin-bottom: 16px;">Wähle die richtigen Antworten oder überspringe mit dem Button unten.</p>`;
    
    chapter.questions.forEach((q, qIndex) => {
        html += `
            <div style="margin-bottom: 24px;">
                <p style="font-weight: 600; margin-bottom: 12px;">${qIndex + 1}. ${q.q}</p>
                ${q.options.map((opt, oIndex) => `
                    <div class="quiz-option" data-q="${qIndex}" data-o="${oIndex}" onclick="selectQuizOption(${qIndex}, ${oIndex})">
                        <div class="radio"></div>
                        <span>${opt}</span>
                    </div>
                `).join('')}
            </div>
        `;
    });
    
    html += `
        <button type="button" class="btn btn-primary btn-block" id="checkQuizBtn" onclick="checkQuiz()">
            Antworten prüfen
        </button>
        <div id="quizFeedback"></div>
    </div>`;
    
    content.innerHTML = html;
}

function selectQuizOption(qIndex, oIndex) {
    quizAnswers[qIndex] = oIndex;
    
    // Update UI
    document.querySelectorAll(`.quiz-option[data-q="${qIndex}"]`).forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelector(`.quiz-option[data-q="${qIndex}"][data-o="${oIndex}"]`).classList.add('selected');
}

function checkQuiz() {
    const chapter = CHAPTERS[currentChapter];
    let correct = 0;
    
    chapter.questions.forEach((q, qIndex) => {
        const userAnswer = quizAnswers[qIndex];
        const options = document.querySelectorAll(`.quiz-option[data-q="${qIndex}"]`);
        
        options.forEach((opt, oIndex) => {
            opt.style.pointerEvents = 'none';
            if (oIndex === q.correct) {
                opt.classList.add('correct');
            } else if (oIndex === userAnswer && userAnswer !== q.correct) {
                opt.classList.add('wrong');
            }
        });
        
        if (userAnswer === q.correct) correct++;
    });
    
    // Track stats
    sessionStats.total += chapter.questions.length;
    sessionStats.correct += correct;
    sessionStats.wrong += chapter.questions.length - correct;
    
    // Show feedback
    const feedback = document.getElementById('quizFeedback');
    feedback.innerHTML = `
        <div style="margin-top: 16px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm); text-align: center;">
            <strong>${correct} von ${chapter.questions.length} richtig!</strong>
        </div>
    `;
    
    document.getElementById('checkQuizBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

// ===== SORTING GAME =====
let sortingItems = [];

function renderSorting(chapter) {
    const content = document.getElementById('contentArea');
    // Shuffle items
    sortingItems = [...chapter.items].sort(() => Math.random() - 0.5);
    
    content.innerHTML = `
        <div class="content-card">
            <h2>Sortier-Spiel</h2>
            <p>${chapter.instruction}</p>
            <p class="text-muted" style="font-size: 0.85rem;">Du kannst auch überspringen wenn du möchtest.</p>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 16px 0;">
                Tippe auf die Begriffe in der richtigen Reihenfolge:
            </p>
            
            <div class="drag-container" id="sourceItems">
                ${sortingItems.map((item, i) => `
                    <div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>
                `).join('')}
            </div>
            
            <p style="color: var(--text-muted); font-size: 0.85rem; margin: 16px 0;">
                Deine Reihenfolge (1 → 5):
            </p>
            
            <div class="drop-zone" id="targetZone"></div>
            
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="resetSorting()" style="flex: 1;">
                    Zurücksetzen
                </button>
                <button type="button" class="btn btn-primary" id="checkSortBtn" onclick="checkSorting()" style="flex: 1;">
                    Prüfen ✓
                </button>
            </div>
            
            <div id="sortFeedback"></div>
        </div>
    `;
}

function selectSortItem(el) {
    const item = el.getAttribute('data-item');
    const target = document.getElementById('targetZone');
    
    // Move to target
    el.remove();
    target.innerHTML += `<div class="drag-item" data-item="${item}" onclick="unselectSortItem(this)">${item}</div>`;
}

function unselectSortItem(el) {
    const item = el.getAttribute('data-item');
    const source = document.getElementById('sourceItems');
    
    // Move back to source
    el.remove();
    source.innerHTML += `<div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>`;
}

function resetSorting() {
    const chapter = CHAPTERS[currentChapter];
    sortingItems = [...chapter.items].sort(() => Math.random() - 0.5);
    
    document.getElementById('sourceItems').innerHTML = sortingItems.map(item => `
        <div class="drag-item" data-item="${item}" onclick="selectSortItem(this)">${item}</div>
    `).join('');
    
    document.getElementById('targetZone').innerHTML = '';
    document.getElementById('sortFeedback').innerHTML = '';
    document.getElementById('checkSortBtn').style.display = 'block';
}

function checkSorting() {
    const chapter = CHAPTERS[currentChapter];
    const userOrder = Array.from(document.querySelectorAll('#targetZone .drag-item')).map(el => el.getAttribute('data-item'));
    
    const isCorrect = JSON.stringify(userOrder) === JSON.stringify(chapter.correctOrder);
    
    sessionStats.total++;
    if (isCorrect) {
        sessionStats.correct++;
    } else {
        sessionStats.wrong++;
    }
    
    const target = document.getElementById('targetZone');
    const feedback = document.getElementById('sortFeedback');
    
    if (isCorrect) {
        target.classList.add('correct');
        feedback.innerHTML = `
            <div style="margin-top: 16px; padding: 16px; background: rgba(0, 204, 136, 0.2); border: 1px solid var(--success); border-radius: var(--radius-sm); text-align: center;">
                <strong style="color: var(--success);">Perfekt!</strong>
            </div>
        `;
    } else {
        target.classList.add('wrong');
        feedback.innerHTML = `
            <div style="margin-top: 16px; padding: 16px; background: rgba(255, 82, 82, 0.2); border: 1px solid var(--danger); border-radius: var(--radius-sm); text-align: center;">
                <strong style="color: var(--danger);">Nicht ganz richtig</strong>
                <p style="color: var(--text-muted); margin-top: 8px;">
                    Richtige Reihenfolge: ${chapter.correctOrder.join(' → ')}
                </p>
            </div>
        `;
    }
    
    document.getElementById('checkSortBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

// ===== FILL IN THE BLANK GAME =====
function renderFillBlank(chapter) {
    const content = document.getElementById('contentArea');
    
    let html = `
        <div class="content-card">
            <h2>Lückentext</h2>
            <p>${chapter.instruction}</p>
            <p class="text-muted" style="font-size: 0.85rem;">Du kannst auch überspringen wenn du möchtest.</p>
            
            <div style="margin-top: 20px;">
    `;
    
    chapter.blanks.forEach((blank, i) => {
        // Split text at ___
        const parts = blank.text.split('___');
        html += `
            <div style="margin-bottom: 20px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm);">
                <p style="font-size: 1.1rem; line-height: 2;">
                    ${parts[0]}
                    <span class="fill-blank">
                        <input type="text" id="blank_${i}" placeholder="?" data-answer="${blank.answer}" style="width: 70px;">
                    </span>
                    ${parts[1] || ''}
                </p>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">Tipp: ${blank.hint}</p>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <button type="button" class="btn btn-primary btn-block" id="checkBlankBtn" onclick="checkFillBlank()">
                Prüfen ✓
            </button>
            
            <div id="blankFeedback"></div>
        </div>
    `;
    
    content.innerHTML = html;
}

function checkFillBlank() {
    const chapter = CHAPTERS[currentChapter];
    let correct = 0;
    
    chapter.blanks.forEach((blank, i) => {
        const input = document.getElementById(`blank_${i}`);
        const userAnswer = input.value.trim().replace(',', '.');
        const correctAnswer = blank.answer.replace(',', '.');
        
        input.disabled = true;
        
        if (userAnswer === correctAnswer) {
            input.classList.add('correct');
            correct++;
        } else {
            input.classList.add('wrong');
            input.value = blank.answer;
        }
    });
    
    sessionStats.total += chapter.blanks.length;
    sessionStats.correct += correct;
    sessionStats.wrong += chapter.blanks.length - correct;
    
    const feedback = document.getElementById('blankFeedback');
    feedback.innerHTML = `
        <div style="margin-top: 16px; padding: 16px; background: var(--glass-bg); border-radius: var(--radius-sm); text-align: center;">
            <strong>${correct} von ${chapter.blanks.length} richtig!</strong>
        </div>
    `;
    
    document.getElementById('checkBlankBtn').style.display = 'none';
    document.getElementById('nextBtn').disabled = false;
}

// ===== FLASHCARDS =====
let currentCard = 0;
let cardFlipped = false;

function renderFlashcards(chapter) {
    const content = document.getElementById('contentArea');
    currentCard = 0;
    cardFlipped = false;
    
    content.innerHTML = `
        <div class="content-card">
            <h2>Schnelltest</h2>
            <p class="text-muted">Tippe auf die Karte um die Antwort zu sehen. Wie viele kannst du ohne Nachdenken?</p>
            
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-inner" id="flashcardInner">
                        <div class="flashcard-front" id="cardFront">
                            ${chapter.cards[0].front}
                        </div>
                        <div class="flashcard-back" id="cardBack">
                            ${chapter.cards[0].back}
                        </div>
                    </div>
                </div>
                
                <div class="flashcard-progress">
                    <span id="cardProgress">1 / ${chapter.cards.length}</span>
                </div>
                
                <div class="flashcard-controls">
                    <button type="button" class="btn btn-secondary" onclick="prevCard()" id="prevCardBtn" disabled>
                        Zurück
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextCard()" id="nextCardBtn">
                        Nächste
                    </button>
                </div>
            </div>
        </div>
    `;
}

function flipCard() {
    cardFlipped = !cardFlipped;
    const inner = document.getElementById('flashcardInner');
    if (cardFlipped) {
        inner.classList.add('flipped');
    } else {
        inner.classList.remove('flipped');
    }
}

function nextCard() {
    const chapter = CHAPTERS[currentChapter];
    if (currentCard < chapter.cards.length - 1) {
        currentCard++;
        updateFlashcard();
    }
}

function prevCard() {
    if (currentCard > 0) {
        currentCard--;
        updateFlashcard();
    }
}

function updateFlashcard() {
    const chapter = CHAPTERS[currentChapter];
    cardFlipped = false;
    document.getElementById('flashcardInner').classList.remove('flipped');
    document.getElementById('cardFront').textContent = chapter.cards[currentCard].front;
    document.getElementById('cardBack').textContent = chapter.cards[currentCard].back;
    document.getElementById('cardProgress').textContent = `${currentCard + 1} / ${chapter.cards.length}`;
    document.getElementById('prevCardBtn').disabled = currentCard === 0;
    document.getElementById('nextCardBtn').disabled = currentCard === chapter.cards.length - 1;
}

// ===== MATCHING GAME =====
let matchingState = { left: null, right: null, matched: [] };

function renderMatching(chapter) {
    const content = document.getElementById('contentArea');
    matchingState = { left: null, right: null, matched: [] };
    
    // Shuffle the right side
    const shuffledRight = [...chapter.pairs.map(p => p.right)].sort(() => Math.random() - 0.5);
    
    content.innerHTML = `
        <div class="content-card">
            <h2>Zuordnungsspiel</h2>
            <p class="text-muted">${chapter.instruction}</p>
            <p class="text-muted" style="font-size: 0.85rem;">Tippe links, dann rechts um zu verbinden.</p>
            
            <div class="matching-container">
                <div class="matching-column" id="leftColumn">
                    ${chapter.pairs.map((p, i) => `
                        <div class="match-item left" data-index="${i}" data-value="${p.left}" onclick="selectMatch(this, 'left')">
                            ${p.left}
                        </div>
                    `).join('')}
                </div>
                <div class="matching-column" id="rightColumn">
                    ${shuffledRight.map((r, i) => `
                        <div class="match-item right" data-index="${i}" data-value="${r}" onclick="selectMatch(this, 'right')">
                            ${r}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div id="matchFeedback" style="margin-top: 16px; text-align: center;"></div>
        </div>
    `;
}

function selectMatch(el, side) {
    const chapter = CHAPTERS[currentChapter];
    const value = el.getAttribute('data-value');
    
    // Remove previous selection on same side
    document.querySelectorAll(`.match-item.${side}`).forEach(item => {
        item.classList.remove('selected');
    });
    
    el.classList.add('selected');
    matchingState[side] = { element: el, value: value };
    
    // Check if both sides selected
    if (matchingState.left && matchingState.right) {
        // Find if it's a correct pair
        const isCorrect = chapter.pairs.some(p => 
            p.left === matchingState.left.value && 
            p.right === matchingState.right.value
        );
        
        if (isCorrect) {
            matchingState.left.element.classList.add('matched');
            matchingState.right.element.classList.add('matched');
            matchingState.left.element.classList.remove('selected');
            matchingState.right.element.classList.remove('selected');
            matchingState.left.element.onclick = null;
            matchingState.right.element.onclick = null;
            matchingState.matched.push(matchingState.left.value);
            sessionStats.correct++;
        } else {
            matchingState.left.element.classList.add('wrong-match');
            matchingState.right.element.classList.add('wrong-match');
            sessionStats.wrong++;
            
            setTimeout(() => {
                matchingState.left.element.classList.remove('wrong-match', 'selected');
                matchingState.right.element.classList.remove('wrong-match', 'selected');
            }, 500);
        }
        
        sessionStats.total++;
        matchingState.left = null;
        matchingState.right = null;
        
        // Check if all matched
        if (matchingState.matched.length === chapter.pairs.length) {
            document.getElementById('matchFeedback').innerHTML = `
                <div style="padding: 16px; background: var(--success); border-radius: var(--radius-sm); color: var(--bg-dark);">
                    <strong>Alle richtig zugeordnet!</strong>
                </div>
            `;
        }
    }
}

function renderResult() {
    const content = document.getElementById('contentArea');
    const accuracy = sessionStats.total > 0 ? Math.round((sessionStats.correct / sessionStats.total) * 100) : 0;
    
    content.innerHTML = `
        <div class="result-hero">
            <div style="font-size: 3rem; color: var(--success); font-weight: bold;">GESCHAFFT!</div>
            <h2>Kurs abgeschlossen!</h2>
            <p style="color: var(--text-muted);">Du hast alle Kapitel durchgearbeitet.</p>
        </div>
        
        <div class="content-card">
            <h2>Deine Ergebnisse</h2>
            
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="number">${sessionStats.correct}</div>
                    <div class="label">Richtig</div>
                </div>
                <div class="stat-item">
                    <div class="number">${sessionStats.wrong}</div>
                    <div class="label">Falsch</div>
                </div>
                <div class="stat-item">
                    <div class="number">${accuracy}%</div>
                    <div class="label">Genauigkeit</div>
                </div>
                <div class="stat-item">
                    <div class="number">${CHAPTERS.length}</div>
                    <div class="label">Kapitel</div>
                </div>
            </div>
        </div>
        
        <div class="content-card">
            <h2>Was du gelernt hast</h2>
            <ul style="color: var(--text-secondary); line-height: 2; padding-left: 20px;">
                <li>Das Kalkulationsschema (MEK → BVP)</li>
                <li>MGK-Zuschlagssätze (32,8% / 35,4% / 108%)</li>
                <li>Fertigungskostenberechnung</li>
                <li>Der Porto-Trick bei Otoplastik</li>
                <li>Vorwärts- und Rückwärtsrechnung</li>
            </ul>
        </div>
        
        <div class="content-card" style="margin-top: 16px;">
            <h2>Merkhilfen</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">
                <strong>MGK-Sätze:</strong> H-H-O (Handelswaren-Höchster, Hörgeräte, Otoplastik)<br>
                108% - 32,8% - 35,4%
            </p>
            <p style="color: var(--text-secondary); margin-bottom: 12px;">
                <strong>Schema:</strong> "Mein Mensch Sucht Neue Bücher"<br>
                MEK → Mges → Sk → NVP → BVP
            </p>
            <p style="color: var(--text-secondary);">
                <strong>Porto:</strong> Immer ZUERST addieren, DANN MGK berechnen!
            </p>
        </div>
        
        <div class="nav-buttons" style="margin-top: 20px;">
            <button type="button" class="btn btn-secondary" onclick="restartCourse()">
                Kurs wiederholen
            </button>
            <a href="./profil.html" class="btn btn-primary" style="text-decoration: none;">
                Zum Profil
            </a>
        </div>
    `;
    
    // Hide default nav
    document.getElementById('navButtons').style.display = 'none';
    
    // Save progress to profile
    saveProgress();
}

function saveProgress() {
    try {
        localStorage.setItem('kurs_completed', 'true');
        localStorage.setItem('kurs_stats', JSON.stringify(sessionStats));
    } catch (e) {}
}

function loadProgress() {
    try {
        const saved = localStorage.getItem('kurs_chapter');
        if (saved) {
            currentChapter = parseInt(saved) || 0;
        }
    } catch (e) {}
}

function saveChapter() {
    try {
        localStorage.setItem('kurs_chapter', currentChapter.toString());
    } catch (e) {}
}

function restartCourse() {
    currentChapter = 0;
    sessionStats = { correct: 0, wrong: 0, total: 0 };
    exerciseResults = [];
    quizAnswers = [];
    saveChapter();
    document.getElementById('navButtons').style.display = 'grid';
    renderContent();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateNavButtons() {
    const chapter = CHAPTERS[currentChapter];
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const navButtons = document.getElementById('navButtons');
    
    prevBtn.disabled = currentChapter === 0;
    
    // Always allow navigation - user can skip or go back freely
    nextBtn.disabled = false;
    nextBtn.textContent = 'Weiter →';
    nextBtn.onclick = goNext;
    
    // Show/hide skip button based on chapter type
    if (chapter.type === 'exercise' || chapter.type === 'quiz' || chapter.type === 'sorting' || chapter.type === 'fillblank') {
        skipBtn.style.display = 'flex';
        navButtons.style.gridTemplateColumns = '1fr 1fr 1fr';
        
        // For exercises, offer "Prüfen" as the main action but still allow skip
        if (chapter.type === 'exercise') {
            nextBtn.textContent = 'Prüfen ✓';
            nextBtn.onclick = () => {
                checkExercise();
                nextBtn.textContent = 'Weiter →';
                nextBtn.onclick = goNext;
            };
        }
    } else {
        skipBtn.style.display = 'none';
        navButtons.style.gridTemplateColumns = '1fr 1fr';
    }
    
    // Hide everything for result page
    if (chapter.type === 'result') {
        navButtons.style.display = 'none';
    } else {
        navButtons.style.display = 'grid';
    }
}

function goPrev() {
    if (currentChapter > 0) {
        currentChapter--;
        saveChapter();
        renderContent();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goNext() {
    if (currentChapter < CHAPTERS.length - 1) {
        currentChapter++;
        saveChapter();
        renderContent();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function showHint() {
    const hintBox = document.getElementById('hintContent');
    hintBox.classList.toggle('show');
}

function closeHint() {
    document.getElementById('hintModal').classList.remove('show');
}

// ===== CHAPTER HELP =====
const CHAPTER_HELP = {
    1: {
        title: "Hilfe: Einführung",
        content: `
            <h4>Was lernst du hier?</h4>
            <p>In diesem Kapitel lernst du die Grundlagen der Kalkulation:</p>
            <ul>
                <li><strong>Kalkulation</strong> = Preisberechnung vom Einkauf zum Verkauf</li>
                <li>Das Schema zeigt alle Schritte in der richtigen Reihenfolge</li>
                <li>Jeder Schritt baut auf dem vorherigen auf</li>
            </ul>
            <h4>Tipp</h4>
            <p>Präge dir die Reihenfolge ein: MEK → Mges → Sk → NVP → BVP</p>
        `
    },
    2: {
        title: "Hilfe: Zuschläge",
        content: `
            <h4>Die drei MGK-Sätze</h4>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>Hörgeräte</td><td style="text-align: right; color: var(--accent);"><strong>32,8%</strong></td></tr>
                <tr><td>Otoplastik/Material</td><td style="text-align: right; color: var(--success);"><strong>35,4%</strong></td></tr>
                <tr><td>Handelswaren</td><td style="text-align: right; color: var(--warning);"><strong>108%</strong></td></tr>
            </table>
            <h4>Stundensätze</h4>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>HG-Anpassung</td><td style="text-align: right;">60,50 €/h</td></tr>
                <tr><td>Audiometrie</td><td style="text-align: right;">63,40 €/h</td></tr>
                <tr><td>Werkstatt</td><td style="text-align: right;">58,90 €/h</td></tr>
            </table>
            <h4>Eselsbrücke</h4>
            <p><strong>Merke: H</strong>andelswaren = <strong>H</strong>öchster Satz (108%)</p>
        `
    },
    3: {
        title: "Hilfe: Beispielrechnung",
        content: `
            <h4>Schritt-für-Schritt</h4>
            <ol style="line-height: 2;">
                <li><strong>MEK</strong> = Einkaufspreis + Porto</li>
                <li><strong>MGK</strong> = MEK × Zuschlag%</li>
                <li><strong>Mges</strong> = MEK + MGK</li>
                <li><strong>Fert</strong> = (Minuten ÷ 60) × Stundensatz</li>
                <li><strong>Sk</strong> = Mges + Fertigung</li>
                <li><strong>NVP</strong> = Sk × (1 + Gewinn%)</li>
                <li><strong>BVP</strong> = NVP × 1,19</li>
            </ol>
        `
    },
    4: {
        title: "Hilfe: Aufgabe 3 (Reparatur)",
        content: `
            <h4>Was ist gegeben?</h4>
            <ul>
                <li>Ersatzteil: <strong>65,50 €</strong> → Das ist dein MEK</li>
                <li>Arbeitszeit: <strong>35 Minuten</strong> Werkstatt</li>
                <li>Gewinn: <strong>9%</strong></li>
                <li>Pauschale: <strong>6,95 €</strong> → Zu Selbstkosten addieren!</li>
            </ul>
            <h4>Welche Werte eintragen?</h4>
            <ul>
                <li>MEK: 65,50</li>
                <li>MGK: 35,4% (Material/Reparatur)</li>
                <li>Minuten: 35</li>
                <li>Rate: 58,90 (Werkstatt)</li>
                <li>Pauschale: 6,95</li>
                <li>Gewinn: 9</li>
            </ul>
        `
    },
    5: {
        title: "Hilfe: Handelswaren",
        content: `
            <h4>Was sind Handelswaren?</h4>
            <p>Produkte, die der Akustiker nicht selbst herstellt:</p>
            <ul>
                <li>Wecksysteme / Lichtwecker</li>
                <li>Batterien</li>
                <li>Pflegeprodukte</li>
                <li>Zubehör</li>
            </ul>
            <h4>Warum 108% MGK?</h4>
            <p>Der hohe Zuschlag deckt Lager, Beratung und Vertrieb ab, da keine eigene Fertigung stattfindet.</p>
        `
    },
    6: {
        title: "Hilfe: Aufgabe 4 (Wecksystem)",
        content: `
            <h4>ACHTUNG: Handelsware!</h4>
            <p>Ein Wecksystem ist eine <strong>Handelsware</strong>, daher:</p>
            <ul>
                <li>MGK-Satz: <strong style="color: var(--warning);">108%</strong> (nicht 35,4%!)</li>
            </ul>
            <h4>Werte zum Eintragen:</h4>
            <ul>
                <li>MEK: 55,00</li>
                <li>MGK: <strong>108</strong></li>
                <li>Minuten: 30</li>
                <li>Rate: 60,50 (HG-Anpassung)</li>
                <li>Gewinn: 12</li>
            </ul>
        `
    },
    7: {
        title: "Hilfe: Aufgabe 9 (Otoplastik)",
        content: `
            <h4>Der Porto-Trick!</h4>
            <p>Bei Transportkosten gilt:</p>
            <ol>
                <li><strong>ZUERST</strong> Porto zu MEK addieren</li>
                <li><strong>DANN</strong> MGK auf die Summe berechnen</li>
            </ol>
            <h4>Rechnung:</h4>
            <p>MEK = 12,80 + 3,50 = <strong>16,30 €</strong></p>
            <p>MGK = 16,30 × 35,4% = 5,77 €</p>
            <h4>Werte:</h4>
            <ul>
                <li>MEK: 12,80</li>
                <li>Porto: 3,50</li>
                <li>MGK: 35,4%</li>
            </ul>
        `
    },
    8: {
        title: "Hilfe: Quiz",
        content: `
            <h4>Quiz-Tipps</h4>
            <ul>
                <li>Wecksystem = Handelsware = <strong>108%</strong></li>
                <li>Werkstatt = <strong>58,90 €/h</strong></li>
                <li>Transportkosten <strong>VOR</strong> MGK addieren</li>
                <li>BVP = NVP × <strong>1,19</strong></li>
            </ul>
        `
    },
    9: {
        title: "Hilfe: Aufgabe 6 (Paar HG)",
        content: `
            <h4>Zwei verschiedene Arbeitszeiten!</h4>
            <p>Diese Aufgabe hat zwei Fertigungskosten:</p>
            <ul>
                <li><strong>90 Min</strong> HG-Anpassung @ 60,50 €/h</li>
                <li><strong>45 Min</strong> Audiometrie @ 63,40 €/h</li>
            </ul>
            <h4>Berechnung:</h4>
            <p>Fert1 = (90÷60) × 60,50 = 90,75 €</p>
            <p>Fert2 = (45÷60) × 63,40 = 47,55 €</p>
            <h4>MGK-Satz:</h4>
            <p>Hörgeräte = <strong>32,8%</strong></p>
        `
    },
    10: {
        title: "Hilfe: Rückrechnung",
        content: `
            <h4>Rückwärts = Umkehrung</h4>
            <p>Statt zu addieren/multiplizieren, subtrahierst/dividierst du:</p>
            <table style="width: 100%; margin: 16px 0;">
                <tr><td>BVP → NVP</td><td style="text-align: right;">÷ 1,19</td></tr>
                <tr><td>NVP → Sk</td><td style="text-align: right;">÷ (1 + Gewinn%)</td></tr>
                <tr><td>Sk → Mges</td><td style="text-align: right;">- Fertigungskosten</td></tr>
                <tr><td>Mges → MEK</td><td style="text-align: right;">÷ (1 + MGK%)</td></tr>
            </table>
        `
    },
    11: {
        title: "Hilfe: Batterien",
        content: `
            <h4>ACHTUNG: Handelsware!</h4>
            <p>Batterien sind <strong>Handelswaren</strong>, daher:</p>
            <ul>
                <li>MGK-Satz: <strong style="color: var(--warning);">108%</strong></li>
            </ul>
            <h4>Rechnung:</h4>
            <p>MEK = 6 × 2,50 = <strong>15,00 €</strong></p>
        `
    },
    12: {
        title: "Hilfe: Reinigungsset",
        content: `
            <h4>Zwei Besonderheiten!</h4>
            <ul>
                <li>Pflegeset = <strong>Handelsware = 108%</strong></li>
                <li>Versandkosten = <strong>ZUERST addieren!</strong></li>
            </ul>
            <h4>Rechnung:</h4>
            <p>MEK = 8,90 + 1,50 = <strong>10,40 €</strong></p>
            <p>Keine Fertigungskosten (keine Beratung)</p>
        `
    },
    15: {
        title: "Hilfe: Gehörschutz",
        content: `
            <h4>Materialberechnung</h4>
            <p>MEK = Grundmaterial + 2 × Filter</p>
            <p>MEK = 15,60 + (2 × 4,20) = <strong>24,00 €</strong></p>
            <h4>Kategorie</h4>
            <p>Gehörschutz = Material/Otoplastik = <strong>35,4%</strong></p>
        `
    },
    default: {
        title: "Hilfe",
        content: `
            <h4>Allgemeine Tipps</h4>
            <ul>
                <li>Lies die Aufgabe <strong>genau</strong> durch</li>
                <li>Achte auf den <strong>Produkttyp</strong> (Hörgerät, Otoplastik, Handelsware)</li>
                <li>Bei Porto: <strong>Erst addieren</strong>, dann MGK berechnen!</li>
                <li>Fertigungskosten: Minuten ÷ 60 × Stundensatz</li>
                <li>Am Ende immer × 1,19 für MwSt</li>
            </ul>
            <h4>Häufige Fehler</h4>
            <ul style="color: var(--danger);">
                <li>Falschen MGK-Satz verwenden</li>
                <li>Porto nach der MGK-Berechnung addieren</li>
                <li>MwSt vergessen</li>
            </ul>
        `
    }
};

function showChapterHelp() {
    const chapter = CHAPTERS[currentChapter];
    const help = CHAPTER_HELP[chapter.id] || CHAPTER_HELP.default;
    
    document.getElementById('hintTitle').textContent = help.title;
    document.getElementById('hintBody').innerHTML = help.content;
    document.getElementById('hintModal').classList.add('show');
}

function skip() {
    // Skip without checking - just go to next chapter
    goNext();
}

// ===== INIT =====
// Note: onclick handlers are set in updateNavButtons() dynamically
document.getElementById('prevBtn').onclick = goPrev;
document.getElementById('skipBtn').onclick = skip;

// Check profile
STORAGE.onReady(async () => {
    await PROFILES.init();
    
    const profile = PROFILES.getCurrent();
    if (!profile) {
        window.location.href = './index.html';
        return;
    }
    
    loadProgress();
    renderContent();
});
</script>

</body>
</html>
